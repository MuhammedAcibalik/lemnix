generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums for Cutting List feature
enum CuttingListStatus {
  DRAFT
  READY
  PROCESSING
  COMPLETED
  ARCHIVED
}

enum ItemPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ProductionPlanPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique @db.VarChar(255)
  name          String?        @db.VarChar(200)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isActive      Boolean        @default(true)
  lastLogin     DateTime?
  password      String?        @db.VarChar(255)
  role          String         @default("planner") @db.VarChar(50)
  cuttingLists  CuttingList[]
  optimizations Optimization[]
  activities    UserActivity[]
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role, isActive])
  @@map("users")
}

model CuttingList {
  id                  String                  @id @default(cuid())
  name                String                  @db.VarChar(200)
  description         String?                 @db.VarChar(1000)
  status              CuttingListStatus       @default(DRAFT)
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  userId              String
  metadata            Json?
  weekNumber          Int?
  sections            Json?
  items               CuttingListItem[]
  statistics          CuttingListStatistics[]
  user                User                    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  productionPlanItems ProductionPlanItem[]

  @@unique([userId, weekNumber])
  @@index([userId, status])
  @@index([weekNumber, status])
  @@index([createdAt(sort: Desc)])
  @@index([status, updatedAt])
  @@index([userId, status, createdAt(sort: Desc)])
  @@index([status, weekNumber, updatedAt])
  @@index([sections(ops: JsonbPathOps)], type: Gin)
  @@index([metadata(ops: JsonbPathOps)], type: Gin)
  @@map("cutting_lists")
}

model CuttingListItem {
  id                   String              @id @default(cuid())
  workOrderId          String              @db.VarChar(100)
  date                 String?             @db.VarChar(50)
  color                String              @db.VarChar(50)
  version              String              @default("1.0") @db.VarChar(50)
  size                 String              @db.VarChar(50)
  profileType          String              @db.VarChar(100)
  length               Decimal             @db.Decimal(10, 2)
  quantity             Int
  orderQuantity        Int?
  cuttingPattern       String?             @db.VarChar(500)
  notes                String?             @db.VarChar(1000)
  priority             ItemPriority        @default(MEDIUM)
  status               CuttingListStatus   @default(DRAFT)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  cuttingListId        String
  materialDescription  String?             @db.VarChar(500)
  materialNumber       String?             @db.VarChar(100)
  productionPlanItemId String?
  cuttingList          CuttingList         @relation(fields: [cuttingListId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  productionPlanItem   ProductionPlanItem? @relation(fields: [productionPlanItemId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([cuttingListId])
  @@index([workOrderId])
  @@index([profileType, color])
  @@index([status, priority])
  @@index([materialNumber])
  @@index([productionPlanItemId])
  @@index([workOrderId, profileType, color])
  @@map("cutting_list_items")
}

model Optimization {
  id            String   @id @default(cuid())
  algorithm     String   @db.VarChar(50)
  status        String   @default("pending") @db.VarChar(50)
  executionTime Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  userId        String
  metadata      Json?
  parameters    Json
  result        Json?
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId, status])
  @@index([algorithm, status])
  @@index([createdAt(sort: Desc)])
  @@index([status, createdAt(sort: Desc)])
  @@index([userId, algorithm, createdAt(sort: Desc)])
  @@index([status, algorithm, createdAt(sort: Desc)])
  @@index([parameters(ops: JsonbPathOps)], type: Gin)
  @@index([result(ops: JsonbPathOps)], type: Gin)
  @@index([metadata(ops: JsonbPathOps)], type: Gin)
  @@map("optimizations")
}

model StockLength {
  id        String   @id @default(cuid())
  length    Decimal  @unique @db.Decimal(10, 2)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stock_lengths")
}

model ProfileType {
  id          String   @id @default(cuid())
  name        String   @unique @db.VarChar(100)
  description String?  @db.VarChar(500)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("profile_types")
}

model CuttingListStatistics {
  id                  String      @id @default(cuid())
  cuttingListId       String      @unique
  totalItems          Int         @default(0)
  totalProfiles       Int         @default(0)
  totalQuantity       Int         @default(0)
  averageWastePercent Decimal     @default(0) @db.Decimal(5, 2)
  optimizationCount   Int         @default(0)
  completionRate      Decimal     @default(0) @db.Decimal(5, 2)
  efficiencyScore     Decimal     @default(0) @db.Decimal(5, 2)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  cuttingList         CuttingList @relation(fields: [cuttingListId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("cutting_list_statistics")
}

model ProfileUsageStatistics {
  id              String    @id @default(cuid())
  profileType     String    @db.VarChar(100)
  profileName     String    @db.VarChar(200)
  measurement     Decimal   @db.Decimal(10, 2)
  totalUsageCount Int       @default(0)
  totalQuantity   Int       @default(0)
  averageQuantity Decimal   @default(0) @db.Decimal(10, 2)
  lastUsed        DateTime?
  frequencyRank   Int       @default(0)
  popularityScore Decimal   @default(0) @db.Decimal(5, 2)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([profileType, profileName, measurement])
  @@map("profile_usage_statistics")
}

model OptimizationStatistics {
  id                    String   @id @default(cuid())
  algorithm             String   @db.VarChar(50)
  inputItemCount        Int      @default(0)
  outputItemCount       Int      @default(0)
  wasteReductionPercent Decimal  @default(0) @db.Decimal(5, 2)
  executionTimeMs       Int      @default(0)
  successRate           Decimal  @default(0) @db.Decimal(5, 2)
  averageEfficiency     Decimal  @default(0) @db.Decimal(5, 2)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  parameters            Json?

  @@index([algorithm, createdAt])
  @@map("optimization_statistics")
}

model SystemMetrics {
  id          String   @id @default(cuid())
  metricType  String   @db.VarChar(100)
  metricName  String   @db.VarChar(200)
  metricValue Decimal  @db.Decimal(15, 4)
  metricUnit  String?  @db.VarChar(50)
  timestamp   DateTime @default(now())
  metadata    Json?

  @@index([metricType, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("system_metrics")
}

model UserActivity {
  id           String   @id @default(cuid())
  userId       String
  activityType String   @db.VarChar(100)
  ipAddress    String?  @db.VarChar(45)
  userAgent    String?  @db.VarChar(500)
  sessionId    String?  @db.VarChar(100)
  createdAt    DateTime @default(now())
  activityData Json?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([activityType, createdAt])
  @@index([createdAt(sort: Desc)])
  @@map("user_activities")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?  @db.VarChar(100)
  tableName String   @db.VarChar(100)
  operation String   @db.VarChar(50)
  recordId  String   @db.VarChar(100)
  oldData   Json?
  newData   Json?
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.VarChar(500)
  timestamp DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([userId, timestamp(sort: Desc)])
  @@index([tableName, operation])
  @@index([recordId])
  @@index([timestamp(sort: Desc)])
  @@map("audit_logs")
}

model SuggestionPattern {
  id              String   @id @default(cuid())
  contextKey      String   @db.VarChar(200)
  patternKey      String   @unique @db.VarChar(500)
  productName     String   @db.VarChar(200)
  size            String   @db.VarChar(50)
  profile         String   @db.VarChar(100)
  measurement     String   @db.VarChar(100)
  quantity        Int
  frequency       Int      @default(1)
  confidence      Decimal  @default(0) @db.Decimal(5, 2)
  lastUsed        DateTime @default(now())
  averageQuantity Decimal  @db.Decimal(10, 2)
  contexts        Json
  variations      Json
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  averageRatio    Decimal  @default(1) @db.Decimal(10, 4)
  orderQuantity   Int      @default(1)
  ratio           Decimal  @default(1) @db.Decimal(10, 4)
  ratioHistory    Json?

  @@index([contextKey, confidence(sort: Desc)])
  @@index([productName, size])
  @@index([profile, measurement])
  @@index([frequency(sort: Desc)])
  @@index([lastUsed(sort: Desc)])
  @@index([orderQuantity, ratio])
  @@index([contexts(ops: JsonbPathOps)], type: Gin)
  @@map("suggestion_patterns")
}

model SuggestionCache {
  id        String   @id @default(cuid())
  cacheKey  String   @unique @db.VarChar(500)
  cacheType String   @db.VarChar(100)
  data      Json
  hitCount  Int      @default(0)
  lastHit   DateTime @default(now())
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cacheType, expiresAt])
  @@index([expiresAt])
  @@map("suggestion_caches")
}

model SuggestionMetrics {
  id                String   @id @default(cuid())
  metricType        String   @db.VarChar(100)
  productName       String?  @db.VarChar(200)
  size              String?  @db.VarChar(50)
  suggestionCount   Int      @default(0)
  acceptanceRate    Decimal  @default(0) @db.Decimal(5, 2)
  averageConfidence Decimal  @default(0) @db.Decimal(5, 2)
  responseTimeMs    Int?
  metadata          Json?
  timestamp         DateTime @default(now())

  @@index([metricType, timestamp(sort: Desc)])
  @@index([productName, size])
  @@map("suggestion_metrics")
}

model ProductionPlan {
  id         String               @id @default(cuid())
  weekNumber Int
  year       Int
  status     String               @default("active") @db.VarChar(50)
  uploadedAt DateTime             @default(now())
  uploadedBy String?              @db.VarChar(100)
  metadata   Json?
  items      ProductionPlanItem[]

  @@unique([weekNumber, year])
  @@index([weekNumber, year, status])
  @@index([uploadedAt(sort: Desc)])
  @@map("production_plans")
}

model ProductionPlanItem {
  id                        String                 @id @default(cuid())
  planId                    String
  ad                        String                 @db.VarChar(200)
  siparisVeren              String                 @db.VarChar(200)
  musteriNo                 String                 @db.VarChar(100)
  musteriKalemi             String                 @db.VarChar(200)
  siparis                   String                 @db.VarChar(100)
  malzemeNo                 String                 @db.VarChar(100)
  malzemeKisaMetni          String                 @db.VarChar(500)
  miktar                    Decimal                @db.Decimal(10, 2)
  planlananBitisTarihi      DateTime
  bolum                     String                 @db.VarChar(100)
  oncelik                   ProductionPlanPriority @default(MEDIUM)
  linkedCuttingListId       String?
  encryptedAd               String?                @db.VarChar(500)
  encryptedMalzemeKisaMetni String?                @db.VarChar(1000)
  encryptedMalzemeNo        String?                @db.VarChar(200)
  encryptedMusteriKalemi    String?                @db.VarChar(500)
  encryptedMusteriNo        String?                @db.VarChar(200)
  encryptedSiparis          String?                @db.VarChar(200)
  encryptedSiparisVeren     String?                @db.VarChar(500)
  linkedCuttingList         CuttingList?           @relation(fields: [linkedCuttingListId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  plan                      ProductionPlan         @relation(fields: [planId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  cuttingListItems          CuttingListItem[]

  @@index([planId])
  @@index([siparis])
  @@index([oncelik, planlananBitisTarihi])
  @@index([bolum, oncelik])
  @@index([linkedCuttingListId])
  @@map("production_plan_items")
}

model MaterialProfileMapping {
  id               String   @id @default(cuid())
  malzemeNo        String   @db.VarChar(100)
  malzemeKisaMetni String   @db.VarChar(500)
  profileType      String   @db.VarChar(100)
  length           Decimal  @db.Decimal(10, 2)
  usageCount       Int      @default(1)
  lastUsed         DateTime @default(now())
  createdBy        String?  @db.VarChar(100)
  createdAt        DateTime @default(now())

  @@unique([malzemeNo, profileType, length])
  @@index([malzemeNo])
  @@index([usageCount, lastUsed])
  @@map("material_profile_mappings")
}

model ProfileDefinition {
  id           String                    @id @default(cuid())
  profileCode  String                    @db.VarChar(100)
  profileName  String                    @db.VarChar(200)
  isActive     Boolean                   @default(true)
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  stockLengths ProfileStockLength[]
  mappings     WorkOrderProfileMapping[]

  @@unique([profileCode])
  @@index([isActive])
  @@index([profileCode, isActive])
  @@map("profile_definitions")
}

model ProfileStockLength {
  id          String            @id @default(cuid())
  profileId   String
  stockLength Decimal           @db.Decimal(10, 2)
  isDefault   Boolean           @default(false)
  priority    Int               @default(0)
  createdAt   DateTime          @default(now())
  profile     ProfileDefinition @relation(fields: [profileId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([profileId, stockLength])
  @@index([profileId, isDefault])
  @@index([profileId, priority])
  @@index([stockLength])
  @@map("profile_stock_lengths")
}

model WorkOrderProfileMapping {
  id          String            @id @default(cuid())
  workOrderId String            @db.VarChar(100)
  profileType String            @db.VarChar(100)
  profileId   String
  weekNumber  Int
  year        Int
  uploadedBy  String?           @db.VarChar(100)
  createdAt   DateTime          @default(now())
  profile     ProfileDefinition @relation(fields: [profileId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@unique([workOrderId, profileType, weekNumber, year])
  @@index([weekNumber, year])
  @@index([profileType])
  @@index([workOrderId])
  @@index([profileId, weekNumber, year])
  @@index([workOrderId, weekNumber, year])
  @@map("work_order_profile_mappings")
}

model ProductCategory {
  id          String           @id @default(cuid())
  name        String           @unique @db.VarChar(200)
  description String?          @db.VarChar(1000)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  products    ProductMapping[]

  @@index([name])
  @@map("product_categories")
}

model ProductMapping {
  id          String          @id @default(cuid())
  productName String          @unique @db.VarChar(200)
  categoryId  String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  category    ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([productName])
  @@index([categoryId])
  @@map("product_mappings")
}
