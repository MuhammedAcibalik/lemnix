# ============================================================================
# Database Metrics Configuration for Prometheus
# ============================================================================
# This file defines database-specific metrics and alerts for Prometheus.
# It should be included in the main prometheus.yml configuration.
#
# Usage:
#   Add to prometheus.yml:
#     rule_files:
#       - "database-metrics.yml"
# ============================================================================

groups:
  - name: database_performance
    interval: 30s
    rules:
      # Slow Query Alert
      - alert: SlowQueryDetected
        expr: |
          pg_stat_statements_mean_exec_time{datname="lemnix_db"} > 1000
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Slow query detected in database"
          description: "Query {{ $labels.queryid }} has mean execution time of {{ $value }}ms"

      # High Query Execution Time
      - alert: HighQueryExecutionTime
        expr: |
          rate(pg_stat_statements_total_exec_time[5m]) > 5000
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High total query execution time"
          description: "Total query execution time is {{ $value }}ms/s over the last 5 minutes"

      # Low Cache Hit Ratio
      - alert: LowCacheHitRatio
        expr: |
          (
            sum(rate(pg_stat_user_tables_heap_blks_hit[5m])) /
            (sum(rate(pg_stat_user_tables_heap_blks_hit[5m])) + sum(rate(pg_stat_user_tables_heap_blks_read[5m])))
          ) < 0.95
        for: 15m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Low cache hit ratio"
          description: "Cache hit ratio is {{ $value | humanizePercentage }}, should be > 95%"

      # High Connection Count
      - alert: HighConnectionCount
        expr: |
          pg_stat_database_numbackends{datname="lemnix_db"} > 150
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High connection count"
          description: "Database has {{ $value }} active connections (limit: 200)"

      # Database Size Growing Rapidly
      - alert: DatabaseSizeGrowingRapidly
        expr: |
          rate(pg_database_size_bytes{datname="lemnix_db"}[1h]) > 1073741824
        for: 1h
        labels:
          severity: info
          component: database
        annotations:
          summary: "Database size growing rapidly"
          description: "Database is growing at {{ $value | humanize1024 }}/hour"

      # Dead Tuples High
      - alert: HighDeadTuples
        expr: |
          (
            sum(pg_stat_user_tables_n_dead_tup) /
            (sum(pg_stat_user_tables_n_live_tup) + sum(pg_stat_user_tables_n_dead_tup))
          ) > 0.1
        for: 1h
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High dead tuple ratio"
          description: "Dead tuple ratio is {{ $value | humanizePercentage }}, consider running VACUUM"

      # Long-Running Transactions
      - alert: LongRunningTransaction
        expr: |
          pg_stat_activity_state{state="active"} == 1
            and (now() - pg_stat_activity_xact_start) > 300
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Long-running transaction detected"
          description: "Transaction {{ $labels.pid }} has been running for {{ $value }}s"

      # Replication Lag (if replication is configured)
      - alert: ReplicationLag
        expr: |
          pg_replication_lag_seconds > 60
        for: 5m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Replication lag detected"
          description: "Replication lag is {{ $value }}s"

  - name: database_availability
    interval: 30s
    rules:
      # Database Down
      - alert: DatabaseDown
        expr: |
          up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database is down"
          description: "PostgreSQL database is not responding"

      # PgBouncer Down
      - alert: PgBouncerDown
        expr: |
          up{job="pgbouncer"} == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PgBouncer is down"
          description: "PgBouncer connection pooler is not responding"

  - name: database_backup
    interval: 1h
    rules:
      # Backup Not Run Recently
      - alert: BackupNotRunRecently
        expr: |
          time() - backup_last_run_timestamp > 86400
        for: 1h
        labels:
          severity: warning
          component: backup
        annotations:
          summary: "Backup not run recently"
          description: "Last backup was {{ $value | humanizeDuration }} ago"

      # Backup Failed
      - alert: BackupFailed
        expr: |
          backup_status == 0
        for: 5m
        labels:
          severity: critical
          component: backup
        annotations:
          summary: "Backup failed"
          description: "Database backup has failed"

      # WAL Archive Not Working
      - alert: WALArchiveNotWorking
        expr: |
          pg_stat_archiver_failed_count > 0
        for: 5m
        labels:
          severity: warning
          component: backup
        annotations:
          summary: "WAL archiving failed"
          description: "WAL archiving has failed {{ $value }} times"

# ============================================================================
# Metric Definitions (for reference)
# ============================================================================
# These metrics should be exported by postgres_exporter or custom exporter:
#
# pg_stat_statements_*:
#   - pg_stat_statements_calls: Number of times query was executed
#   - pg_stat_statements_total_exec_time: Total execution time (ms)
#   - pg_stat_statements_mean_exec_time: Mean execution time (ms)
#   - pg_stat_statements_max_exec_time: Max execution time (ms)
#
# pg_stat_database_*:
#   - pg_stat_database_numbackends: Number of active connections
#   - pg_stat_database_xact_commit: Number of committed transactions
#   - pg_stat_database_xact_rollback: Number of rolled back transactions
#
# pg_stat_user_tables_*:
#   - pg_stat_user_tables_seq_scan: Sequential scans
#   - pg_stat_user_tables_idx_scan: Index scans
#   - pg_stat_user_tables_n_live_tup: Live tuples
#   - pg_stat_user_tables_n_dead_tup: Dead tuples
#   - pg_stat_user_tables_heap_blks_hit: Heap blocks hit
#   - pg_stat_user_tables_heap_blks_read: Heap blocks read
#
# pg_stat_user_indexes_*:
#   - pg_stat_user_indexes_idx_scan: Index scans
#   - pg_stat_user_indexes_idx_tup_read: Tuples read via index
#   - pg_stat_user_indexes_idx_tup_fetch: Tuples fetched via index
#
# Custom metrics (from application):
#   - backup_last_run_timestamp: Unix timestamp of last backup
#   - backup_status: 1 = success, 0 = failed
#   - pg_replication_lag_seconds: Replication lag in seconds
# ============================================================================

