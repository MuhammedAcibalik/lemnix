---
description: Feature-Sliced Design (FSD) architecture guidelines for Lemnix project
globs: frontend/src/**/*.ts,frontend/src/**/*.tsx
---

# Feature-Sliced Design (FSD) Architecture

## Layer Hierarchy

```
app â†’ pages â†’ widgets â†’ features â†’ entities â†’ shared
```

**Dependency Rule**: Layers can only import from layers below them, never above.

## Layer Definitions

### ðŸ“± app/
**Purpose**: Application initialization and global setup

**Contains**:
- Providers (React Query, Theme, Router)
- Root component
- Global error boundaries
- App-level routing configuration

**Examples**:
- `app/providers/QueryProvider.tsx`
- `app/components/AppRouter.tsx`
- `app/index.tsx`

**âŒ Should NOT contain**: Business logic, UI components, API calls

---

### ðŸ“„ pages/
**Purpose**: Route-level composition of widgets and features

**Contains**:
- Page components (one per route)
- Page-specific layout
- Route parameter handling

**Examples**:
- `pages/HomePage/index.tsx`
- `pages/StatisticsPage/index.tsx`

**âœ… Can import**: widgets, features, entities, shared
**âŒ Should NOT contain**: Business logic, direct API calls

---

### ðŸ§© widgets/
**Purpose**: Complex, self-contained UI blocks composed of features and entities

**Contains**:
- Multi-feature compositions
- Dashboard cards
- Complex forms
- Navigation components

**Examples**:
- `widgets/optimization-history/` - History list widget
- `widgets/statistics-dashboard/` - Stats overview widget

**âœ… Can import**: features, entities, shared
**âŒ Should NOT import**: pages, app
**âŒ Should NOT contain**: Direct API calls (use entities)

**Structure**:
```
widgets/
â””â”€â”€ widget-name/
    â”œâ”€â”€ ui/              # UI components
    â”‚   â”œâ”€â”€ WidgetMain.tsx
    â”‚   â””â”€â”€ WidgetCard.tsx
    â”œâ”€â”€ model/           # Widget-specific state (optional)
    â”‚   â””â”€â”€ useWidgetState.ts
    â””â”€â”€ index.ts         # Public API
```

---

### âš¡ features/
**Purpose**: User actions and interactions (one feature = one user action)

**Contains**:
- Action-oriented functionality
- User interaction handlers
- Feature-specific business logic

**Examples**:
- `features/algorithm-comparison/` - Compare algorithms action
- `features/export-results/` - Export action

**âœ… Can import**: entities, shared
**âŒ Should NOT import**: widgets, pages, app

**Structure**:
```
features/
â””â”€â”€ feature-name/
    â”œâ”€â”€ ui/              # Feature UI
    â”‚   â”œâ”€â”€ FeatureButton.tsx
    â”‚   â””â”€â”€ FeatureDialog.tsx
    â”œâ”€â”€ model/           # Feature logic
    â”‚   â”œâ”€â”€ useFeature.ts
    â”‚   â””â”€â”€ types.ts
    â”œâ”€â”€ api/             # Feature-specific API (optional)
    â”‚   â””â”€â”€ featureApi.ts
    â””â”€â”€ index.ts         # Public API
```

---

### ðŸ¢ entities/
**Purpose**: Domain business entities and their operations

**Contains**:
- Domain models
- API clients for entity operations
- React Query hooks for entity data
- Entity-specific types

**Examples**:
- `entities/optimization/` - Optimization domain
- `entities/statistics/` - Statistics domain

**âœ… Can import**: shared
**âŒ Should NOT import**: features, widgets, pages, app

**Structure**:
```
entities/
â””â”€â”€ entity-name/
    â”œâ”€â”€ model/           # Domain models & types
    â”‚   â””â”€â”€ types.ts
    â”œâ”€â”€ api/             # API client
    â”‚   â”œâ”€â”€ entityApi.ts
    â”‚   â””â”€â”€ entityQueries.ts
    â”œâ”€â”€ ui/              # Entity-specific UI (optional)
    â”‚   â””â”€â”€ EntityCard.tsx
    â””â”€â”€ index.ts         # Public API
```

---

### ðŸ”§ shared/
**Purpose**: Reusable technical utilities (no business logic)

**Contains**:
- UI primitives (Button, Input, Card)
- Utility functions
- API client
- Config
- Common types
- Hooks

**Examples**:
- `shared/ui/Button.tsx`
- `shared/lib/hooks/useDebounce.ts`
- `shared/api/client.ts`
- `shared/config/constants.ts`

**âœ… Can import**: Nothing (lowest layer)
**âŒ Should NOT contain**: Business logic, domain models

**Structure**:
```
shared/
â”œâ”€â”€ ui/              # Primitive components
â”‚   â”œâ”€â”€ Button/
â”‚   â”œâ”€â”€ Input/
â”‚   â””â”€â”€ Card/
â”œâ”€â”€ lib/             # Utilities
â”‚   â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ validation/
â”‚   â””â”€â”€ webgpu/
â”œâ”€â”€ api/             # API client
â”‚   â””â”€â”€ client.ts
â”œâ”€â”€ config/          # Constants
â”‚   â””â”€â”€ constants.ts
â””â”€â”€ types/           # Common types
    â””â”€â”€ common.ts
```

## Public API Pattern

### Every module MUST export through index.ts

```typescript
// âŒ BAD - Direct import
import { validatePassword } from '@/features/auth/lib/validators';

// âœ… GOOD - Public API
import { useAuth, LoginForm } from '@/features/auth';
```

### index.ts Structure
```typescript
// features/auth/index.ts

// Export UI components
export { LoginForm } from './ui/LoginForm';
export { LogoutButton } from './ui/LogoutButton';

// Export hooks
export { useAuth } from './model/useAuth';

// Export types
export type { AuthState, LoginCredentials } from './model/types';

// âŒ DON'T export internal utilities
// export { validatePassword } from './lib/validators';
```

## Common Anti-Patterns

### âŒ Circular Dependencies
```typescript
// features/auth imports features/user
import { UserProfile } from '@/features/user';

// features/user imports features/auth
import { useAuth } from '@/features/auth';

// Solution: Move shared logic to entities layer
```

### âŒ Widgets importing Widgets
```typescript
// widgets/header imports widgets/footer
import { Footer } from '@/widgets/footer';

// Solution: Compose both in pages layer
```

### âŒ Shared with Business Logic
```typescript
// âŒ shared/lib/calculateDiscount.ts
export function calculateDiscount(user: User, product: Product) {
  // Business logic doesn't belong in shared
}

// âœ… Move to entities/order/lib/calculations.ts
```

### âŒ Direct API Calls in Widgets
```typescript
// âŒ widgets/user-list/ui/UserList.tsx
const users = await fetch('/api/users').then(r => r.json());

// âœ… Use entity API
import { useUsers } from '@/entities/user';
const { data: users } = useUsers();
```

## Lemnix-Specific Conventions

### Optimization Domain
```
entities/optimization/
â”œâ”€â”€ model/
â”‚   â”œâ”€â”€ types.ts           # AlgorithmType, OptimizationResult, etc.
â”‚   â””â”€â”€ schemas.ts         # Zod schemas
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ optimizationApi.ts # API functions
â”‚   â””â”€â”€ optimizationQueries.ts # React Query hooks
â””â”€â”€ index.ts               # Public API
```

### Statistics Domain
```
entities/statistics/
â”œâ”€â”€ model/
â”‚   â””â”€â”€ types.ts           # StatisticsOverview, AlgorithmPerformance
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ statisticsApi.ts
â”‚   â””â”€â”€ statisticsQueries.ts
â””â”€â”€ index.ts
```

### WebGPU (Shared Technical Utility)
```
shared/lib/webgpu/
â”œâ”€â”€ types.ts               # WebGPUStatus, WebGPUInfo
â”œâ”€â”€ api.ts                 # API client
â”œâ”€â”€ useWebGPU.ts           # React hook
â””â”€â”€ index.ts
```

## Migration Checklist

When adding new functionality:

- [ ] Determine correct layer (entities â†’ features â†’ widgets â†’ pages)
- [ ] Create proper folder structure with `index.ts`
- [ ] Export only public API
- [ ] Ensure dependency direction is bottom-up
- [ ] Add types to appropriate model/types.ts
- [ ] Document in this rule if it's a new pattern

## File References

- [App Layer](mdc:frontend/src/App/)
- [Optimization Entity](mdc:frontend/src/entities/optimization/)
- [Statistics Entity](mdc:frontend/src/entities/statistics/)
- [Algorithm Comparison Feature](mdc:frontend/src/features/algorithm-comparison/)
- [Export Results Feature](mdc:frontend/src/features/export-results/)
- [Optimization History Widget](mdc:frontend/src/widgets/optimization-history/)
- [Statistics Dashboard Widget](mdc:frontend/src/widgets/statistics-dashboard/)
- [Shared Layer](mdc:frontend/src/shared/)
