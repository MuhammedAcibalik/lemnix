import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
import { responsiveSpacing, gradients } from '../theme/designSystem';
import {
  Box,
  Card,
  CardContent,
  Typography,
  TextField,
  Button,
  IconButton,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Divider,
  Alert,
  Chip,
  Avatar,
  Tooltip,
  CircularProgress,
  Snackbar,
  Stack,
  Collapse,
  LinearProgress,
  Grid,
  Fab,
  SpeedDial,
  SpeedDialAction,
  SpeedDialIcon,
  Autocomplete,
  Paper,
  List,
  ListItem,
  ListItemText,
  ListItemIcon,
  ListItemButton,
  Checkbox,
  RadioGroup,
  Radio,
  FormControl,
  FormLabel,
  FormControlLabel,
  Switch,
  Slider,
  InputAdornment,
  Badge,
  Tabs,
  Tab,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  Stepper,
  Step,
  StepLabel,
  StepContent,
  MobileStepper,
  Drawer,
  AppBar,
  Toolbar,
  Menu,
  MenuItem,
  Popover,
  Backdrop,
  Zoom,
  Fade,
  Slide,
  Grow,
  Container,
  Skeleton,
  AlertTitle,
  Breadcrumbs,
  Link,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TablePagination,
  TableSortLabel,
  Pagination,
  Rating,
  ToggleButton,
  ToggleButtonGroup,
  InputLabel,
  Select,
  ImageList,
  ImageListItem,
  ImageListItemBar,
  SvgIcon,
  useTheme,
  useMediaQuery,
  alpha,
  styled,
  keyframes,
} from '@mui/material';
import {
  Add as AddIcon,
  Delete as DeleteIcon,
  Edit as EditIcon,
  Save as SaveIcon,
  Category as CategoryIcon,
  List as ListIcon,
  ExpandMore as ExpandMoreIcon,
  ExpandLess as ExpandLessIcon,
  ContentCopy as CopyIcon,
  GetApp as ExportIcon,
  PictureAsPdf as PdfIcon,
  TableChart as ExcelIcon,
  Analytics as AnalyticsIcon,
  Inventory as InventoryIcon,
  Assignment as AssignmentIcon,
  TrendingUp as TrendingUpIcon,
  Dashboard as DashboardIcon,
  Lightbulb as LightbulbIcon,
  AutoAwesome as AutoAwesomeIcon,
  Palette as PaletteIcon,
  Straighten as StraightenIcon,
  Numbers as NumbersIcon,
  DateRange as DateRangeIcon,
  Badge as BadgeIcon,
  Notes as NotesIcon,
  Architecture as ArchitectureIcon,
  Psychology as PsychologyIcon,
  SmartButton as SmartButtonIcon,
  Rocket as RocketIcon,
  FlashOn as FlashOnIcon,
  TouchApp as TouchAppIcon,
  Speed as SpeedIcon,
  Memory as MemoryIcon,
  CloudDone as CloudDoneIcon,
  Star as StarIcon,
  Favorite as FavoriteIcon,
  Share as ShareIcon,
  Download as DownloadIcon,
  Upload as UploadIcon,
  Search as SearchIcon,
  FilterList as FilterListIcon,
  Sort as SortIcon,
  ViewList as ViewListIcon,
  ViewModule as ViewModuleIcon,
  ViewComfy as ViewComfyIcon,
  GridView as GridViewIcon,
  Apps as AppsIcon,
  Menu as MenuIcon,
  Close as CloseIcon,
  Check as CheckIcon,
  Warning as WarningIcon,
  Error as ErrorIcon,
  Info as InfoIcon,
  Help as HelpIcon,
  Settings as SettingsIcon,
  MoreVert as MoreVertIcon,
  MoreHoriz as MoreHorizIcon,
  Refresh as RefreshIcon,
  Sync as SyncIcon,
  CloudSync as CloudSyncIcon,
  Wifi as WifiIcon,
  WifiOff as WifiOffIcon,
  SignalWifi4Bar as SignalWifi4BarIcon,
  SignalWifiOff as SignalWifiOffIcon,
  Bluetooth as BluetoothIcon,
  BluetoothConnected as BluetoothConnectedIcon,
  BluetoothDisabled as BluetoothDisabledIcon,
  BatteryFull as BatteryFullIcon,
  BatteryStd as BatteryStdIcon,
  BatteryStd as BatteryLowIcon,
  BatteryAlert as BatteryAlertIcon,
  VolumeUp as VolumeUpIcon,
  VolumeDown as VolumeDownIcon,
  VolumeOff as VolumeOffIcon,
  Mic as MicIcon,
  MicOff as MicOffIcon,
  Videocam as VideocamIcon,
  VideocamOff as VideocamOffIcon,
  CameraAlt as CameraAltIcon,
  PhotoCamera as PhotoCameraIcon,
  VideoCall as VideoCallIcon,
  Call as CallIcon,
  CallEnd as CallEndIcon,
  Phone as PhoneIcon,
  PhoneInTalk as PhoneInTalkIcon,
  PhoneDisabled as PhoneDisabledIcon,
  Message as MessageIcon,
  Chat as ChatIcon,
  ChatBubble as ChatBubbleIcon,
  ChatBubbleOutline as ChatBubbleOutlineIcon,
  Sms as SmsIcon,
  Email as EmailIcon,
  Mail as MailIcon,
  MailOutline as MailOutlineIcon,
  Send as SendIcon,
  Reply as ReplyIcon,
  Forward as ForwardIcon,
  AttachFile as AttachFileIcon,
  AttachMoney as AttachMoneyIcon,
  Link as LinkIcon,
  LinkOff as LinkOffIcon,
  InsertLink as InsertLinkIcon,
  ContentCut as ContentCutIcon,
  ContentPaste as ContentPasteIcon,
  ContentCopy as ContentCopyIcon,
  ContentPasteGo as ContentPasteGoIcon,
  Undo as UndoIcon,
  Redo as RedoIcon,
  History as HistoryIcon,
  Restore as RestoreIcon,
  RestoreFromTrash as RestoreFromTrashIcon,
  DeleteForever as DeleteForeverIcon,
  DeleteSweep as DeleteSweepIcon,
  Clear as ClearIcon,
  ClearAll as ClearAllIcon,
  Refresh as RefreshIcon2,
  Sync as SyncIcon2,
  SyncProblem as SyncProblemIcon,
  SyncDisabled as SyncDisabledIcon,
  Cloud as CloudIcon,
  CloudOff as CloudOffIcon,
  CloudQueue as CloudQueueIcon,
  CloudDone as CloudDoneIcon2,
  CloudDownload as CloudDownloadIcon,
  CloudUpload as CloudUploadIcon,
  CloudSync as CloudSyncIcon2,
  CloudCircle as CloudCircleIcon,
  CloudDoneOutlined as CloudDoneOutlineIcon,
  CloudOffOutlined as CloudOffOutlineIcon,
  CloudQueueOutlined as CloudQueueOutlineIcon,
  CloudDownloadOutlined as CloudDownloadOutlineIcon,
  CloudUploadOutlined as CloudUploadOutlineIcon,
  CloudSyncOutlined as CloudSyncOutlineIcon,
  CloudCircleOutlined as CloudCircleOutlineIcon,
  Timeline as TimelineIcon,
} from '@mui/icons-material';
import axios, { AxiosError, CancelTokenSource } from 'axios';
import { useProfileSuggestions } from '../hooks/useProfileSuggestions';

// Custom hook for localStorage
const useLocalStorage = <T,>(key: string, initialValue: T): [T, (value: T) => void] => {
  const [storedValue, setStoredValue] = useState<T>(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error(`Error reading localStorage key "${key}":`, error);
      return initialValue;
    }
  });

  const setValue = (value: T) => {
    try {
      setStoredValue(value);
      window.localStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      console.error(`Error setting localStorage key "${key}":`, error);
    }
  };

  return [storedValue, setValue];
};

// ============================================================================
// MODERN TYPE DEFINITIONS FOR SMART WORK ORDER CREATION
// ============================================================================

interface SmartProfileItem {
  id: string;
  profile: string;
  measurement: string;
  quantity: number;
  confidence?: number;
  isSuggested?: boolean;
  source?: 'ai' | 'history' | 'manual';
  lastUsed?: string;
  frequency?: number;
}

interface SmartWorkOrder {
  id: string;
  workOrderId: string;
  date: string;
  version: string;
  color: string;
  note?: string;
  orderQuantity: number;
  size: string;
  profiles: SmartProfileItem[];
  status: 'draft' | 'ready' | 'processing' | 'completed';
  priority: 'low' | 'medium' | 'high' | 'urgent';
  estimatedTime?: number;
  actualTime?: number;
  efficiency?: number;
  createdAt: string;
  updatedAt: string;
}

interface SmartProductSection {
  id: string;
  productName: string;
  items: SmartWorkOrder[];
  createdAt: string;
  updatedAt: string;
  totalItems: number;
  totalProfiles: number;
  averageEfficiency: number;
}

interface SmartCuttingList {
  id: string;
  title: string;
  weekNumber: number;
  sections: SmartProductSection[];
  createdAt: string;
  updatedAt: string;
  totalWorkOrders: number;
  totalProfiles: number;
  overallEfficiency: number;
  status: 'active' | 'archived' | 'template';
}

interface SmartProfileFormItem {
  id: string;
  profile: string;
  measurement: string;
  quantity: string;
  confidence?: number;
  isSuggested?: boolean;
  source?: 'ai' | 'history' | 'manual';
}

interface SmartWorkOrderForm {
  workOrderId: string;
  date: string;
  version: string;
  color: string;
  note: string;
  orderQuantity: string;
  size: string;
  profiles: SmartProfileFormItem[];
  priority: 'low' | 'medium' | 'high' | 'urgent';
}

interface SmartSuggestion {
  id: string;
  type: 'profile' | 'measurement' | 'quantity' | 'complete_set';
  value: string;
  confidence: number;
  source: 'ai' | 'history' | 'pattern';
  context?: string;
  metadata?: Record<string, any>;
}

interface SmartInsight {
  id: string;
  type: 'efficiency' | 'cost' | 'time' | 'quality';
  message: string;
  severity: 'info' | 'warning' | 'error' | 'success';
  actionable: boolean;
  action?: string;
}

enum LoadingState {
  IDLE = 'idle',
  LOADING = 'loading',
  SUCCESS = 'success',
  ERROR = 'error'
}

interface AppError {
  message: string;
  code?: string;
  details?: unknown;
  timestamp?: number;
}

interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
}

// ============================================================================
// MODERN STYLED COMPONENTS
// ============================================================================

const pulseAnimation = keyframes`
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
`;

const slideInAnimation = keyframes`
  0% { transform: translateY(-20px); opacity: 0; }
  100% { transform: translateY(0); opacity: 1; }
`;

const glowAnimation = keyframes`
  0% { box-shadow: 0 0 5px rgba(33, 150, 243, 0.5); }
  50% { box-shadow: 0 0 20px rgba(33, 150, 243, 0.8); }
  100% { box-shadow: 0 0 5px rgba(33, 150, 243, 0.5); }
`;

const ModernCard = styled(Card)(({ theme }) => ({
  borderRadius: 16,
  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.1)',
  backdropFilter: 'blur(10px)',
  border: '1px solid rgba(255, 255, 255, 0.2)',
  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  '&:hover': {
    transform: 'translateY(-4px)',
    boxShadow: '0 16px 48px rgba(0, 0, 0, 0.15)',
  },
}));

const SmartButton = styled(Button)(({ theme }) => ({
  borderRadius: 12,
  textTransform: 'none',
  fontWeight: 600,
  padding: '12px 24px',
  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
  '&:hover': {
    transform: 'translateY(-2px)',
    boxShadow: '0 8px 25px rgba(0, 0, 0, 0.15)',
  },
}));

const FloatingActionButton = styled(Fab)(({ theme }) => ({
  position: 'fixed',
  bottom: 24,
  right: 24,
  zIndex: 1000,
  animation: `${pulseAnimation} 2s infinite`,
  '&:hover': {
    animation: `${glowAnimation} 1s infinite`,
  },
}));

const SmartTextField = styled(TextField)(({ theme }) => ({
  '& .MuiOutlinedInput-root': {
    borderRadius: 12,
    transition: 'all 0.3s ease',
    '&:hover': {
      transform: 'translateY(-1px)',
    },
    '&.Mui-focused': {
      transform: 'translateY(-2px)',
      boxShadow: '0 8px 25px rgba(33, 150, 243, 0.15)',
    },
  },
}));

const AnimatedContainer = styled(Box)(({ theme }) => ({
  animation: `${slideInAnimation} 0.6s ease-out`,
}));

const GradientBackground = styled(Box)(({ theme }) => ({
  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
  minHeight: '100vh',
  position: 'relative',
  '&::before': {
    content: '""',
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    background: 'radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%)',
    pointerEvents: 'none',
  },
}));

// ============================================================================
// CUSTOM HOOKS FOR BETTER CODE ORGANIZATION
// ============================================================================

const useDebounce = <T,>(value: T, delay: number): T => {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(handler);
    };
  }, [value, delay]);

  return debouncedValue;
};


// ============================================================================
// ERROR BOUNDARY COMPONENT
// ============================================================================

interface ErrorBoundaryState {
  hasError: boolean;
  error?: Error;
}

class ErrorBoundary extends React.Component<{ children: React.ReactNode }, ErrorBoundaryState> {
  constructor(props: { children: React.ReactNode }) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('Error caught by boundary:', error, errorInfo);
  }

  render(): React.ReactNode {
    if (this.state.hasError) {
      return (
        <Box sx={{ p: 4, textAlign: 'center' }}>
          <Typography variant="h6" color="error" gutterBottom>
            Bir hata olu≈ütu
          </Typography>
          <Typography variant="body2" color="text.secondary">
            {this.state.error?.message || 'Bilinmeyen hata'}
          </Typography>
          <Button 
            variant="contained" 
            sx={{ mt: 2 }}
            onClick={() => this.setState({ hasError: false })}
          >
            Tekrar Dene
          </Button>
        </Box>
      );
    }

    return this.props.children;
  }
}

// ============================================================================
// SMART WORK ORDER CREATION CENTER - MAIN COMPONENT
// ============================================================================

export const CuttingListBuilder: React.FC = (): React.ReactElement => {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down('md'));
  const isTablet = useMediaQuery(theme.breakpoints.down('lg'));
  // Refs for performance optimization
  const cancelTokenRef = useRef<CancelTokenSource | null>(null);
  const autoSaveTimeoutRef = useRef<number | null>(null);
  const suggestionTimeoutRef = useRef<number | null>(null);

  // Utility functions
  const getCurrentWeekNumber = useCallback((): number => {
    const now = new Date();
    const startOfYear = new Date(now.getFullYear(), 0, 1);
    const days = Math.floor((now.getTime() - startOfYear.getTime()) / (24 * 60 * 60 * 1000));
    return Math.ceil((days + startOfYear.getDay() + 1) / 7);
  }, []);

  // Current week number as stable value
  const currentWeekNumber = useMemo(() => {
    const week = getCurrentWeekNumber();
    console.log('üìÖ Current week number calculated:', week);
    return week;
  }, [getCurrentWeekNumber]);

  // Modern state management with smart features
  const [smartCuttingList, setSmartCuttingList] = useLocalStorage<SmartCuttingList | null>('smartCuttingList', null);
  const [smartCuttingLists, setSmartCuttingLists] = useState<SmartCuttingList[]>([]);
  const [title, setTitle] = useState<string>('');
  const [selectedWeekNumber, setSelectedWeekNumber] = useState<number>(currentWeekNumber);
  const [productName, setProductName] = useState<string>('');
  
  // Smart suggestion states
  const [smartSuggestions, setSmartSuggestions] = useState<SmartSuggestion[]>([]);
  const [smartInsights, setSmartInsights] = useState<SmartInsight[]>([]);
  const [isAIAnalyzing, setIsAIAnalyzing] = useState<boolean>(false);
  const [suggestionConfidence, setSuggestionConfidence] = useState<number>(0);
  
  // UI states
  const [activeTab, setActiveTab] = useState<number>(0);
  const [viewMode, setViewMode] = useState<'grid' | 'list' | 'timeline'>('grid');
  const [searchQuery, setSearchQuery] = useState<string>('');
  const [filterStatus, setFilterStatus] = useState<string>('all');
  const [sortBy, setSortBy] = useState<string>('date');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');

  // Form states
  const [newItemForm, setNewItemForm] = useState<SmartWorkOrderForm>({
    workOrderId: '',
    date: new Date().toISOString().split('T')[0],
    version: '1.0',
    color: '',
    note: '',
    orderQuantity: '1',
    size: '',
    priority: 'medium',
    profiles: []
  });

  // Loading and error states
  const [loadingState, setLoadingState] = useState<LoadingState>(LoadingState.IDLE);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);
  
  // Auto-generated title based on week number
  const autoGeneratedTitle = useMemo(() => {
    return `${selectedWeekNumber}. HAFTA KESƒ∞M Lƒ∞STESƒ∞`;
  }, [selectedWeekNumber]);

  // Update title when week number changes
  useEffect(() => {
    setTitle(autoGeneratedTitle);
  }, [autoGeneratedTitle]);
  
  // ============================================================================
  // SMART AI SUGGESTION SYSTEM
  // ============================================================================

  const getSmartSuggestions = useCallback(async (
    productName: string,
    size: string,
    context?: Record<string, any>
  ): Promise<SmartSuggestion[]> => {
    if (!productName.trim() || !size.trim()) return [];

    setIsAIAnalyzing(true);
    try {
      const response = await axios.get<ApiResponse<SmartSuggestion[]>>(
        `/api/cutting-list/smart/suggestions`,
        {
          params: {
            productName: productName.trim(),
            size: size.trim(),
            context: JSON.stringify(context || {}),
            limit: 10
          }
        }
      );

      if (response.data.success && response.data.data) {
        const suggestions = response.data.data;
        setSmartSuggestions(suggestions);
        
        // Calculate overall confidence
        const avgConfidence = suggestions.reduce((sum, s) => sum + s.confidence, 0) / suggestions.length;
        setSuggestionConfidence(avgConfidence);
        
        return suggestions;
      }
    } catch (error) {
      console.error('Smart suggestions error:', error);
    } finally {
      setIsAIAnalyzing(false);
    }
    return [];
  }, []);

  const getSmartInsights = useCallback(async (
    workOrderData: SmartWorkOrderForm
  ): Promise<SmartInsight[]> => {
    try {
      const response = await axios.post<ApiResponse<SmartInsight[]>>(
        `/api/cutting-list/smart/insights`,
        workOrderData
      );

      if (response.data.success && response.data.data) {
        setSmartInsights(response.data.data);
        return response.data.data;
      }
    } catch (error) {
      console.error('Smart insights error:', error);
    }
    return [];
  }, []);

  // ============================================================================
  // ONE-CLICK SMART FEATURES
  // ============================================================================

  const applySmartProfileSet = useCallback((suggestion: SmartSuggestion) => {
    if (suggestion.type === 'complete_set' && suggestion.metadata?.profiles) {
      const profiles = suggestion.metadata.profiles as SmartProfileFormItem[];
      setNewItemForm(prev => ({
        ...prev,
        profiles: profiles.map(p => ({
          ...p,
          isSuggested: true,
          source: 'ai' as const,
          confidence: suggestion.confidence
        }))
      }));
      
      setSuccess(`‚úÖ ${profiles.length} profil AI √∂nerisi ile eklendi! (G√ºven: %${suggestion.confidence})`);
    }
  }, []);

  const quickAddProfile = useCallback((profile: SmartSuggestion) => {
    if (profile.type === 'profile' && profile.metadata) {
      const newProfile: SmartProfileFormItem = {
        id: `smart-${Date.now()}`,
        profile: profile.value,
        measurement: profile.metadata.measurement || '',
        quantity: profile.metadata.quantity || '1',
        confidence: profile.confidence,
        isSuggested: true,
        source: 'ai'
      };

      setNewItemForm(prev => ({
        ...prev,
        profiles: [...prev.profiles, newProfile]
      }));

      setSuccess(`‚ö° ${profile.value} profili tek tu≈üla eklendi!`);
    }
  }, []);

  const smartDuplicate = useCallback((workOrder: SmartWorkOrder) => {
    const duplicated: SmartWorkOrderForm = {
      workOrderId: `${workOrder.workOrderId}-COPY`,
      date: new Date().toISOString().split('T')[0],
      version: workOrder.version,
      color: workOrder.color,
      note: workOrder.note || '',
      orderQuantity: workOrder.orderQuantity.toString(),
      size: workOrder.size,
      priority: workOrder.priority,
      profiles: workOrder.profiles.map(p => ({
        id: `copy-${Date.now()}-${Math.random()}`,
        profile: p.profile,
        measurement: p.measurement,
        quantity: p.quantity.toString(),
        confidence: p.confidence,
        isSuggested: false,
        source: 'manual'
      }))
    };

    setNewItemForm(duplicated);
    setSuccess(`üìã ƒ∞≈ü emri kopyalandƒ± ve forma y√ºklendi!`);
  }, []);
  
  // Dialog states
  const [showNewProductDialog, setShowNewProductDialog] = useState<boolean>(false);
  const [showNewItemDialog, setShowNewItemDialog] = useState<boolean>(false);
  const [showEditItemDialog, setShowEditItemDialog] = useState<boolean>(false);
  
  // Form states
  const [currentSectionId, setCurrentSectionId] = useState<string>('');
  const [editingItem, setEditingItem] = useState<SmartWorkOrder | null>(null);
  const [expandedSections, setExpandedSections] = useState<Set<string>>(new Set());
  const [isAutoSaving, setIsAutoSaving] = useState<boolean>(false);


  // Manual save to server function
  const saveToServer = useCallback(async () => {
    if (!smartCuttingList) return;
    
    try {
      setIsAutoSaving(true);
      
      // Try to create a new cutting list on server
      const createResponse = await axios.post<ApiResponse<SmartCuttingList>>(
        'http://localhost:3001/api/cutting-list',
        {
          title: smartCuttingList.title,
          weekNumber: smartCuttingList.weekNumber
        }
      );
      
      if (createResponse.data.success && createResponse.data.data) {
        const newList = createResponse.data.data;
        const updatedList = {
          ...smartCuttingList,
          id: newList.id,
          updatedAt: new Date().toISOString()
        };
        
        // Save full content
        await axios.put<ApiResponse<SmartCuttingList>>(
          `http://localhost:3001/api/cutting-list/${newList.id}`,
          updatedList
        );
        
        setSmartCuttingList(updatedList);
        
        setSuccess('‚úÖ Kesim listesi ba≈üarƒ±yla sunucuya kaydedildi!');
        console.log('‚úÖ Successfully saved cutting list to server');
      }
    } catch (error) {
      console.error('Failed to save to server:', error);
      setError('‚ùå Sunucuya kaydetme ba≈üarƒ±sƒ±z. L√ºtfen tekrar deneyin.');
    } finally {
      setIsAutoSaving(false);
    }
  }, [smartCuttingList, setSmartCuttingList]);
  
  // Smart suggestions state
  const [profileSuggestions, setProfileSuggestions] = useState<string[]>([]);
  const [measurementSuggestions, setMeasurementSuggestions] = useState<string[]>([]);
  const [totalQuantityCalculation, setTotalQuantityCalculation] = useState<number>(0);
  const [productNameSuggestions, setProductNameSuggestions] = useState<string[]>([]);
  const [enterpriseProfileSuggestions, setEnterpriseProfileSuggestions] = useState<Array<{
    profile: string;
    measurement: string;
    suggestedQuantity: number;
    confidence: number;
  }>>([]);
  const [contextualInsights, setContextualInsights] = useState<string[]>([]);
  
  // Product sizes and complete profile sets
  const [availableSizes, setAvailableSizes] = useState<Array<{size: string; frequency: number; lastUsed: string}>>([]);
  const [completeProfileSet, setCompleteProfileSet] = useState<{
    profiles: Array<{
      profile: string;
      measurement: string;
      suggestedQuantity: number;
      confidence: number;
      averageOrderQuantity: number;
    }>;
    totalItems: number;
    averageTotalQuantity: number;
  } | null>(null);
  
  // Debounced values for search optimization
  const debouncedProductName = useDebounce(productName, 300);
  
  // Legacy loading state for backward compatibility
  const loading = loadingState === LoadingState.LOADING;

  // Profile suggestions hook
  const {
    similarProducts,
    searchSimilarProducts,
    getSizesForProduct,
    clearSuggestions
  } = useProfileSuggestions();

  // Enhanced error handling
  const handleError = useCallback((error: unknown, context: string): void => {
    let errorMessage = 'Bilinmeyen hata';

    if (axios.isAxiosError(error)) {
      const axiosError = error as AxiosError<{ error?: string; message?: string }>;
      errorMessage = axiosError.response?.data?.error || 
                        axiosError.response?.data?.message || 
                        axiosError.message || 
                        'Aƒü hatasƒ±';
      
      // Special handling for 404 errors in cutting list operations
      if (axiosError.response?.status === 404 && context.includes('cuttingList')) {
        console.warn(`[${context}] Cutting list not found - this may indicate a sync issue between frontend and backend`);
        
        // If this is a cutting list operation, suggest clearing localStorage
        if (smartCuttingList?.id) {
          errorMessage = 'Kesim listesi sunucuda bulunamadƒ±. Yerel veriler temizlenecek.';
          // Clear the problematic cutting list
          setTimeout(() => setSmartCuttingList(null), 1000);
        }
      }
      
      console.error(`Axios error in ${context}:`, {
        status: axiosError.response?.status,
        statusText: axiosError.response?.statusText,
        data: axiosError.response?.data,
        message: axiosError.message,
        code: axiosError.code
      });
    } else if (error instanceof Error) {
      errorMessage = error.message;
      console.error(`Standard error in ${context}:`, error);
    } else {
      console.error(`Unknown error type in ${context}:`, error);
    }

    setError(errorMessage);
    setLoadingState(LoadingState.ERROR);
    console.error(`Processed error in ${context}:`, errorMessage);
  }, [smartCuttingList, setSmartCuttingList]);

  // Load cutting lists from backend
  const loadCuttingListsFromBackend = useCallback(async (): Promise<void> => {
    if (cancelTokenRef.current) {
      cancelTokenRef.current.cancel('New request initiated');
    }

    cancelTokenRef.current = axios.CancelToken.source();
    
    setLoadingState(LoadingState.LOADING);
    
    try {
      const response = await axios.get<ApiResponse<SmartCuttingList[]>>(
        'http://localhost:3001/api/cutting-list',
        { cancelToken: cancelTokenRef.current.token }
      );
      
      if (!response.data.success) {
        throw new Error(response.data.error || 'API ba≈üarƒ±sƒ±z yanƒ±t d√∂nd√º');
      }
      
      const responseData = response.data.data || [];
      
      // Handle different response formats
      let backendLists: unknown[];
      if (Array.isArray(responseData)) {
        backendLists = responseData;
      } else if (responseData && typeof responseData === 'object' && 'lists' in responseData) {
        // Handle {lists: Array} format
        const listsData = (responseData as { lists: unknown }).lists;
        if (Array.isArray(listsData)) {
          backendLists = listsData;
        } else {
          console.warn('Backend response.lists is not an array:', typeof listsData, listsData);
          throw new Error('Ge√ßersiz API yanƒ±tƒ±: response.lists Array bekleniyordu');
        }
      } else {
        console.warn('Backend response format unknown:', typeof responseData, responseData);
        throw new Error('Ge√ßersiz API yanƒ±tƒ±: Array veya {lists: Array} bekleniyordu');
      }
      
      const validLists = backendLists
        .filter((list): list is SmartCuttingList => 
          list !== null && 
          typeof list === 'object' &&
          'weekNumber' in list &&
          typeof list.weekNumber !== 'undefined'
        )
        .map(list => ({
          ...list,
          sections: Array.isArray(list.sections) ? list.sections : [],
          createdAt: list.createdAt || new Date().toISOString(),
          updatedAt: list.updatedAt || new Date().toISOString(),
          weekNumber: parseInt(String(list.weekNumber)) || 1,
          totalWorkOrders: list.totalWorkOrders || 0,
          totalProfiles: list.totalProfiles || 0,
          overallEfficiency: list.overallEfficiency || 0,
          status: list.status || 'active'
        }));
      
      setSmartCuttingLists(validLists);
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      if (!axios.isCancel(error)) {
        console.error('Raw error in loadCuttingLists:', error);
        handleError(error, 'loadCuttingLists');
      }
    }
  }, [handleError]);

  // Auto-save functionality with enhanced validation
  const autoSaveCuttingList = useCallback(async (): Promise<void> => {
    if (!smartCuttingList?.id || isAutoSaving || loadingState !== LoadingState.SUCCESS) {
      console.log('Auto-save skipped:', { 
        hasId: !!smartCuttingList?.id, 
        isAutoSaving, 
        loadingState 
      });
      return;
    }

    setIsAutoSaving(true);
    
    try {
      // First verify the cutting list still exists
      await axios.get(`http://localhost:3001/api/cutting-list/${smartCuttingList.id}`);
      
      // If it exists, proceed with save
      await axios.put<ApiResponse<SmartCuttingList>>(
        `http://localhost:3001/api/cutting-list/${smartCuttingList.id}`,
        smartCuttingList
      );
      // Auto-save successful
    } catch (error) {
      // If cutting list doesn't exist on server, DON'T DELETE - try to recreate it
      if (axios.isAxiosError(error) && error.response?.status === 404) {
        // Silently attempt to recreate during auto-save
        
        try {
          // Try to recreate the cutting list on server
          const recreateResponse = await axios.post<ApiResponse<SmartCuttingList>>(
            'http://localhost:3001/api/cutting-list',
            {
              title: smartCuttingList.title,
              weekNumber: smartCuttingList.weekNumber
            }
          );
          
          if (recreateResponse.data.success && recreateResponse.data.data) {
            // Update the ID and save again
            const recreatedList = recreateResponse.data.data;
            const updatedList = {
              ...smartCuttingList,
              id: recreatedList.id,
              updatedAt: new Date().toISOString()
            };
            
            setSmartCuttingList(updatedList);
            console.log('‚úÖ Successfully recreated cutting list on server');
            
            // Now save the content
            await axios.put<ApiResponse<SmartCuttingList>>(
              `http://localhost:3001/api/cutting-list/${recreatedList.id}`,
              updatedList
            );
            console.log('‚úÖ Auto-save completed after recreation');
          }
        } catch (recreateError) {
          console.error('Failed to recreate cutting list:', recreateError);
          setError('Otomatik kaydetme ba≈üarƒ±sƒ±z. Verileriniz g√ºvende - manuel olarak kaydedin.');
        }
        return;
      }
    } finally {
      setIsAutoSaving(false);
    }
  }, [smartCuttingList, isAutoSaving, setSmartCuttingList, loadingState]);

  // Setup auto-save - only after validation is complete
  useEffect(() => {
    if (smartCuttingList && smartCuttingList.id && loadingState === LoadingState.SUCCESS) {
      // Clear any existing timeout
      if (autoSaveTimeoutRef.current) {
        clearTimeout(autoSaveTimeoutRef.current);
      }
      
      // Set up new auto-save timeout
      autoSaveTimeoutRef.current = window.setTimeout(() => {
        autoSaveCuttingList();
      }, 5000);
    } else {
      // Clear timeout if no cutting list or not validated yet
      if (autoSaveTimeoutRef.current) {
        clearTimeout(autoSaveTimeoutRef.current);
        autoSaveTimeoutRef.current = null;
      }
    }

    return () => {
      if (autoSaveTimeoutRef.current) {
        clearTimeout(autoSaveTimeoutRef.current);
        autoSaveTimeoutRef.current = null;
      }
    };
  }, [smartCuttingList, autoSaveCuttingList, loadingState]);

  // Backend health check
  const checkBackendHealth = useCallback(async (): Promise<boolean> => {
    try {
      await axios.get('http://localhost:3001/api/cutting-list', { timeout: 5000 });
      return true;
    } catch (error) {
      console.error('Backend health check failed:', error);
      return false;
    }
  }, []);

  // Initial load and validation
  useEffect(() => {
    const initializeApp = async () => {
      setLoadingState(LoadingState.LOADING);
      
      try {
        // First check if backend is healthy
        const isBackendHealthy = await checkBackendHealth();
        if (!isBackendHealthy) {
          handleError(new Error('Backend sunucusuna eri≈üilemiyor. L√ºtfen sunucunun √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun.'), 'backendHealth');
          return;
        }

        // Load all cutting lists from backend
        await loadCuttingListsFromBackend();
        
        // Trigger enterprise analysis refresh
        try {
          await axios.post('http://localhost:3001/api/cutting-list/enterprise/refresh');
          console.log('üß† Enterprise analysis refreshed');
          
          // Check stats
          const statsResponse = await axios.get('http://localhost:3001/api/cutting-list/enterprise/stats');
          if (statsResponse.data.success) {
            const stats = statsResponse.data.data;
            console.log(`üìä Enterprise stats: ${stats.totalPatterns} patterns, ${stats.contextGroups} groups`);
            
            // Test suggestion endpoint
            const testResponse = await axios.get('http://localhost:3001/api/cutting-list/enterprise/profiles?productName=ƒ∞NCE HELEZON&size=100X50X20&limit=5');
            if (testResponse.data.success) {
              console.log('üß™ Test suggestions:', testResponse.data.data.suggestions?.length || 0);
            }
          }
        } catch (error) {
          console.warn('Enterprise refresh failed:', error);
        }
        
        // Then validate current cutting list if exists - BUT DON'T AUTO-DELETE
        if (smartCuttingList?.id) {
          try {
            await axios.get(`http://localhost:3001/api/cutting-list/${smartCuttingList.id}`);
            // Validation successful
          } catch (error: unknown) {
            if (axios.isAxiosError(error) && error.response?.status === 404) {
              // Silently attempt recovery
              
              // Try to recreate the cutting list on server
              try {
                const recreateResponse = await axios.post<ApiResponse<SmartCuttingList>>(
                  'http://localhost:3001/api/cutting-list',
                  {
                    title: smartCuttingList.title,
                    weekNumber: smartCuttingList.weekNumber
                  }
                );
                
                if (recreateResponse.data.success && recreateResponse.data.data) {
                  // Update the ID and save the full content
                  const recreatedList = recreateResponse.data.data;
                  const recoveredList = {
                    ...smartCuttingList,
                    id: recreatedList.id,
                    updatedAt: new Date().toISOString()
                  };
                  
                  // Save the full content to server
                  await axios.put<ApiResponse<SmartCuttingList>>(
                    `http://localhost:3001/api/cutting-list/${recreatedList.id}`,
                    recoveredList
                  );
                  
                  setSmartCuttingList(recoveredList);
                  // Silent recovery success
                  
                  setSuccess('üîÑ Kesim listesi ba≈üarƒ±yla sunucuya geri y√ºklendi!');
                } else {
                  throw new Error('Failed to recreate cutting list');
                }
              } catch (recoveryError) {
                // Silent recovery failure
                setError('‚ö†Ô∏è Kesim listesi sunucuda bulunamadƒ±. Verileriniz g√ºvende - "Sunucuya Kaydet" butonunu kullanƒ±n.');
              }
            } else {
              console.error('Error validating cutting list:', error);
            }
          }
        }
        
        setLoadingState(LoadingState.SUCCESS);
      } catch (error) {
        handleError(error, 'initialization');
      }
    };

    initializeApp();
    
    return () => {
      if (cancelTokenRef.current) {
        cancelTokenRef.current.cancel('Component unmounting');
      }
    };
  }, [loadCuttingListsFromBackend, smartCuttingList, checkBackendHealth, handleError]);


  // Memoized calculations
  const cuttingListStats = useMemo(() => {
    if (!smartCuttingList) return null;
    
    const totalSections = smartCuttingList.sections?.length || 0;
    const totalItems = smartCuttingList.sections?.reduce((total: number, section: SmartProductSection) => 
      total + (section.items?.length || 0), 0
    ) || 0;
    const totalProfiles = smartCuttingList.sections?.reduce((total: number, section: SmartProductSection) => 
      total + (section.items?.reduce((sum: number, item: SmartWorkOrder) => 
        sum + (item.profiles?.length || 0), 0
      ) || 0), 0
    ) || 0;
    
    return { totalSections, totalItems, totalProfiles };
  }, [smartCuttingList]);

  // Form validation
  const validateNewItemForm = useCallback((): string | null => {
    if (!currentSectionId || !smartCuttingList) {
      return 'Ge√ßersiz b√∂l√ºm se√ßimi';
    }

    const requiredFields: Array<{ field: string; name: string }> = [
      { field: newItemForm.workOrderId.trim(), name: 'ƒ∞≈ü Emri' },
      { field: newItemForm.date.trim(), name: 'Tarih' },
      { field: newItemForm.version.trim(), name: 'Versiyon' },
      { field: newItemForm.color.trim(), name: 'Renk' },
      { field: newItemForm.orderQuantity.trim(), name: 'Sipari≈ü Adedi' },
      { field: newItemForm.size.trim(), name: 'Ebat' }
    ];

    for (const { field, name } of requiredFields) {
      if (!field) {
        return `${name} alanƒ± gereklidir`;
      }
    }

    const orderQuantity = parseInt(newItemForm.orderQuantity.trim());
    if (isNaN(orderQuantity) || orderQuantity <= 0) {
      return 'Sipari≈ü adedi ge√ßerli bir pozitif sayƒ± olmalƒ±dƒ±r';
    }

    if (newItemForm.profiles.length === 0) {
      return 'En az bir profil gereklidir';
    }

    for (let i = 0; i < newItemForm.profiles.length; i++) {
      const profile = newItemForm.profiles[i];
      
      if (!profile.measurement.trim()) {
        return `${i + 1}. profil i√ßin √∂l√ß√º gereklidir`;
      }
      
      if (!profile.quantity.trim()) {
        return `${i + 1}. profil i√ßin adet gereklidir`;
      }
      
      const quantity = parseInt(profile.quantity.trim());
      if (isNaN(quantity) || quantity <= 0) {
        return `${i + 1}. profil adedi ge√ßerli bir pozitif sayƒ± olmalƒ±dƒ±r`;
      }
    }

    return null;
  }, [currentSectionId, smartCuttingList, newItemForm]);

  const isFormValid = useMemo(() => validateNewItemForm() === null, [validateNewItemForm]);

  const sortedCuttingLists = useMemo(() => 
    [...smartCuttingLists].sort((a, b) => b.weekNumber - a.weekNumber),
    [smartCuttingLists]
  );

  // Create cutting list
  const createCuttingList = useCallback(async (): Promise<void> => {
    if (!title.trim()) {
      handleError(new Error('Ba≈ülƒ±k gereklidir'), 'createCuttingList');
      return;
    }

    setLoadingState(LoadingState.LOADING);
    
    try {
      const response = await axios.post<ApiResponse<SmartCuttingList>>(
        'http://localhost:3001/api/cutting-list',
        { title: title.trim(), weekNumber: selectedWeekNumber }
      );
      
      if (!response.data.success || !response.data.data) {
        throw new Error(response.data.error || 'Kesim listesi olu≈üturulamadƒ±');
      }
      
      const newCuttingList: SmartCuttingList = {
        ...response.data.data,
        weekNumber: selectedWeekNumber,
        totalWorkOrders: 0,
        totalProfiles: 0,
        overallEfficiency: 0,
        status: 'active'
      };
      
      await loadCuttingListsFromBackend();
      setSmartCuttingList(newCuttingList);
      setTitle('');
      setSuccess(`${selectedWeekNumber}. Hafta kesim listesi ba≈üarƒ±yla olu≈üturuldu`);
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      if (error instanceof AxiosError && error.response?.status === 409) {
        // 409 Conflict - Hafta √ßakƒ±≈ümasƒ±
        const errorMessage = error.response?.data?.error || `${selectedWeekNumber}. hafta i√ßin zaten kesim listesi mevcut`;
        
        // Kullanƒ±cƒ±ya se√ßenek sun
        const shouldContinue = window.confirm(
          `‚ö†Ô∏è HAFTA √áAKI≈ûMASI\n\n${errorMessage}\n\n` +
          `Se√ßenekler:\n` +
          `‚Ä¢ TAMAM: Farklƒ± bir hafta numarasƒ± deneyin\n` +
          `‚Ä¢ ƒ∞PTAL: Mevcut listeyi g√∂r√ºnt√ºlemek i√ßin Ge√ßmi≈ü Haftalar'a gidin`
        );
        
        if (!shouldContinue) {
          // Kullanƒ±cƒ± iptal etti, mevcut listeyi bul ve y√ºkle
          try {
            const existingList = smartCuttingLists.find(list => list.weekNumber === selectedWeekNumber);
            if (existingList) {
              setSmartCuttingList(existingList);
              setSuccess(`${selectedWeekNumber}. hafta kesim listesi y√ºklendi`);
              console.log('Switched to existing cutting list:', existingList.id);
            }
          } catch (switchError) {
            console.error('Failed to switch to existing list:', switchError);
          }
        } else {
          // Hafta numarasƒ±nƒ± otomatik artƒ±r
          const nextWeek = selectedWeekNumber + 1;
          setSelectedWeekNumber(nextWeek > 53 ? 1 : nextWeek);
        }
        
        // Error'u g√∂ster ama daha user-friendly
        const userError = new Error(`${selectedWeekNumber}. hafta i√ßin zaten kesim listesi mevcut. L√ºtfen farklƒ± bir hafta se√ßin.`);
        handleError(userError, 'createCuttingList');
      } else {
        handleError(error, 'createCuttingList');
      }
    }
  }, [title, selectedWeekNumber, smartCuttingLists, handleError, loadCuttingListsFromBackend, setSmartCuttingList]);

  // Add product section
  const addProductSection = useCallback(async (): Promise<void> => {
    if (!productName.trim()) {
      handleError(new Error('√úr√ºn adƒ± gereklidir'), 'addProductSection');
      return;
    }

    if (!smartCuttingList) {
      handleError(new Error('√ñnce kesim listesi olu≈üturun'), 'addProductSection');
      return;
    }

    setLoadingState(LoadingState.LOADING);
    
    try {
      const response = await axios.post<ApiResponse<SmartProductSection>>(
        `http://localhost:3001/api/cutting-list/${smartCuttingList.id}/sections`,
        { productName: productName.trim() }
      );
      
      if (!response.data.success || !response.data.data) {
        throw new Error(response.data.error || '√úr√ºn b√∂l√ºm√º eklenemedi');
      }
      
      const updatedSections = [...smartCuttingList.sections, response.data.data];
      setSmartCuttingList({ ...smartCuttingList, sections: updatedSections });
      setProductName('');
      setProductNameSuggestions([]);
      setShowNewProductDialog(false);
      setSuccess('√úr√ºn b√∂l√ºm√º ba≈üarƒ±yla eklendi');
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      handleError(error, 'addProductSection');
    }
  }, [productName, smartCuttingList, handleError]);

  // Add item to section
  const addItemToSection = useCallback(async (): Promise<void> => {
    const validationError = validateNewItemForm();
    if (validationError) {
      handleError(new Error(validationError), 'addItemToSection');
      return;
    }

    if (!currentSectionId || !smartCuttingList) return;

    setLoadingState(LoadingState.LOADING);
    
    try {
      const itemData = {
        workOrderId: newItemForm.workOrderId,
        date: newItemForm.date,
        version: newItemForm.version,
        color: newItemForm.color,
        note: newItemForm.note || '',
        orderQuantity: parseInt(newItemForm.orderQuantity),
        size: newItemForm.size,
        priority: newItemForm.priority,
        profiles: newItemForm.profiles.map(p => ({
          profile: p.profile || '',
          measurement: p.measurement,
          quantity: parseInt(p.quantity)
        }))
      };

      const response = await axios.post<ApiResponse<SmartWorkOrder>>(
        `http://localhost:3001/api/cutting-list/${smartCuttingList.id}/sections/${currentSectionId}/items`,
        itemData
      );
      
      if (!response.data.success || !response.data.data) {
        throw new Error(response.data.error || '√ñƒüe eklenemedi');
      }
      
      const updatedSections = smartCuttingList.sections.map((section: SmartProductSection) => {
        if (section.id === currentSectionId) {
          return { ...section, items: [...section.items, response.data.data!] };
        }
        return section;
      });
      
      setSmartCuttingList({ ...smartCuttingList, sections: updatedSections });
      resetNewItemForm();
      setShowNewItemDialog(false);
      setSuccess('√ñƒüe ba≈üarƒ±yla eklendi');
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      handleError(error, 'addItemToSection');
    }
  }, [validateNewItemForm, currentSectionId, smartCuttingList, newItemForm, handleError]);

  // Update item in section
  const updateItemInSection = useCallback(async (): Promise<void> => {
    if (!editingItem || !currentSectionId || !smartCuttingList) return;

    const validationError = validateNewItemForm();
    if (validationError) {
      handleError(new Error(validationError), 'updateItemInSection');
      return;
    }

    setLoadingState(LoadingState.LOADING);
    
    try {
      const itemData = {
        ...editingItem,
        workOrderId: newItemForm.workOrderId,
        date: newItemForm.date,
        version: newItemForm.version,
        color: newItemForm.color,
        note: newItemForm.note || '',
        orderQuantity: parseInt(newItemForm.orderQuantity),
        size: newItemForm.size,
        priority: newItemForm.priority,
        profiles: newItemForm.profiles.map(p => ({
          id: p.id,
          profile: p.profile || '',
          measurement: p.measurement,
          quantity: parseInt(p.quantity)
        }))
      };

      const response = await axios.put<ApiResponse<SmartWorkOrder>>(
        `http://localhost:3001/api/cutting-list/${smartCuttingList.id}/sections/${currentSectionId}/items/${editingItem.id}`,
        itemData
      );
      
      if (!response.data.success || !response.data.data) {
        throw new Error(response.data.error || '√ñƒüe g√ºncellenemedi');
      }
      
      const updatedSections = smartCuttingList.sections.map((section: SmartProductSection) => {
        if (section.id === currentSectionId) {
          return {
            ...section,
            items: section.items.map((item: SmartWorkOrder) =>
              item.id === editingItem.id ? response.data.data! : item
            )
          };
        }
        return section;
      });
      
      setSmartCuttingList({ ...smartCuttingList, sections: updatedSections });
      resetNewItemForm();
      setEditingItem(null);
      setShowEditItemDialog(false);
      setSuccess('√ñƒüe ba≈üarƒ±yla g√ºncellendi');
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      handleError(error, 'updateItemInSection');
    }
  }, [editingItem, currentSectionId, smartCuttingList, newItemForm, validateNewItemForm, handleError]);

  // Delete item from section
  const deleteItem = useCallback(async (sectionId: string, itemId: string): Promise<void> => {
    if (!smartCuttingList) return;

    setLoadingState(LoadingState.LOADING);
    
    try {
      await axios.delete(
        `http://localhost:3001/api/cutting-list/${smartCuttingList.id}/sections/${sectionId}/items/${itemId}`
      );
      
      const updatedSections = smartCuttingList.sections.map((section: SmartProductSection) => {
        if (section.id === sectionId) {
          return {
            ...section,
            items: section.items.filter((item: SmartWorkOrder) => item.id !== itemId)
          };
        }
        return section;
      });
      
      setSmartCuttingList({ ...smartCuttingList, sections: updatedSections });
      setSuccess('√ñƒüe ba≈üarƒ±yla silindi');
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      handleError(error, 'deleteItem');
    }
  }, [smartCuttingList, handleError]);

  // Delete section
  const deleteSection = useCallback(async (sectionId: string): Promise<void> => {
    if (!smartCuttingList) return;

    setLoadingState(LoadingState.LOADING);
    
    try {
      await axios.delete(
        `http://localhost:3001/api/cutting-list/${smartCuttingList.id}/sections/${sectionId}`
      );
      
      const updatedSections = smartCuttingList.sections.filter((section: SmartProductSection) => section.id !== sectionId);
      setSmartCuttingList({ ...smartCuttingList, sections: updatedSections });
      setSuccess('B√∂l√ºm ba≈üarƒ±yla silindi');
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      handleError(error, 'deleteSection');
    }
  }, [smartCuttingList, handleError]);

  // Reset form
  const resetNewItemForm = useCallback(() => {
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
    setNewItemForm({
      workOrderId: '',
      date: today,
      version: '',
      color: '',
      note: '',
      orderQuantity: '',
      size: '',
      priority: 'medium',
      profiles: [{ id: '1', profile: '', measurement: '', quantity: '' }]
    });
  }, []);

  // Handle form changes with context-aware suggestions
  const handleFormChange = useCallback((field: keyof Omit<SmartWorkOrderForm, 'profiles'>, value: string) => {
    const uppercaseValue = field === 'orderQuantity' ? value : value.toUpperCase();
    
    setNewItemForm(prev => {
      const updated = { ...prev, [field]: uppercaseValue };
      
      // Trigger enterprise suggestions and complete profile set when size changes
      if (field === 'size' && uppercaseValue.length > 1) {
        const currentSection = smartCuttingList?.sections.find((s: SmartProductSection) => s.id === currentSectionId);
        if (currentSection?.productName) {
          console.log('üöÄ Triggering suggestions for:', currentSection.productName, uppercaseValue);
          
          // Load complete profile set for this size with order quantity
          if (uppercaseValue.length > 2) {
            getCompleteProfileSet(currentSection.productName, uppercaseValue, updated.orderQuantity);
          }
          
          // Also get enterprise suggestions
          setTimeout(() => {
            try {
              getEnterpriseProfileSuggestions(
                currentSection.productName,
                uppercaseValue,
                updated.note,
                updated.version,
                updated.color
              );
            } catch (error) {
              console.log('Enterprise suggestions not ready yet:', error);
            }
          }, 100);
        } else {
          console.log('‚ö†Ô∏è No product name found for suggestions');
        }
      }
      
      // Sipari≈ü adedi deƒüi≈ütiƒüinde profil adetlerini yeniden hesapla
      if (field === 'orderQuantity' && value && parseInt(value) > 0) {
        const currentSection = smartCuttingList?.sections.find((s: SmartProductSection) => s.id === currentSectionId);
        if (currentSection?.productName && updated.size && updated.size.length > 2) {
          console.log('üì¶ Sipari≈ü adedi deƒüi≈üti, profil adetlerini yeniden hesaplƒ±yorum...');
          setTimeout(() => {
            getCompleteProfileSet(currentSection.productName, updated.size, value);
          }, 300);
        }
      }
      
      // Also trigger when other context fields change
      if (['note', 'version', 'color'].includes(field) && uppercaseValue.length > 0) {
        const currentSection = smartCuttingList?.sections.find((s: SmartProductSection) => s.id === currentSectionId);
        if (currentSection?.productName && updated.size) {
          setTimeout(() => {
            try {
              getEnterpriseProfileSuggestions(
                currentSection.productName,
                updated.size,
                updated.note,
                updated.version,
                updated.color
              );
            } catch (error) {
              console.log('Enterprise suggestions not ready yet');
            }
          }, 100);
        }
      }
      
      return updated;
    });
  }, [smartCuttingList, currentSectionId]);

  // Add profile
  const addProfile = useCallback(() => {
    const newProfileId = (newItemForm.profiles.length + 1).toString();
    setNewItemForm(prev => ({
      ...prev,
      profiles: [...prev.profiles, { 
        id: newProfileId, 
        profile: '', 
        measurement: '', 
        quantity: '' 
      }]
    }));
  }, [newItemForm.profiles.length]);

  // Remove profile
  const removeProfile = useCallback((profileId: string) => {
    if (newItemForm.profiles.length > 1) {
      setNewItemForm(prev => ({
        ...prev,
        profiles: prev.profiles.filter(profile => profile.id !== profileId)
      }));
    }
  }, [newItemForm.profiles.length]);

  // Handle new item dialog
  const handleNewItem = useCallback((sectionId: string) => {
    setCurrentSectionId(sectionId);
    setShowNewItemDialog(true);
    
    // Trigger enterprise suggestions for this section
    const currentSection = smartCuttingList?.sections.find((s: SmartProductSection) => s.id === sectionId);
    if (currentSection?.productName) {
      console.log('üéØ Preparing enterprise suggestions for section:', currentSection.productName);
      // Clear previous suggestions
      setEnterpriseProfileSuggestions([]);
      setContextualInsights([]);
    }
  }, [smartCuttingList]);

  // Handle edit item dialog
  const handleEditItem = useCallback((sectionId: string, item: SmartWorkOrder) => {
    setCurrentSectionId(sectionId);
    setEditingItem(item);
    
    // Convert date to YYYY-MM-DD format if needed
    let formattedDate = item.date;
    if (formattedDate && formattedDate.includes('.')) {
      // Convert DD.MM.YYYY to YYYY-MM-DD
      const parts = formattedDate.split('.');
      if (parts.length === 3) {
        formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
      }
    }
    
    setNewItemForm({
      workOrderId: item.workOrderId,
      date: formattedDate,
      version: item.version,
      color: item.color,
      note: item.note || '',
      orderQuantity: item.orderQuantity.toString(),
      size: item.size,
      priority: item.priority,
      profiles: item.profiles.map((profile: SmartProfileItem) => ({
        id: profile.id,
        profile: profile.profile || '',
        measurement: profile.measurement,
        quantity: profile.quantity.toString()
      }))
    });
    
    setShowEditItemDialog(true);
  }, []);

  // Toggle section expansion
  const toggleSectionExpansion = useCallback((sectionId: string) => {
    setExpandedSections(prev => {
      const newSet = new Set(prev);
      if (newSet.has(sectionId)) {
        newSet.delete(sectionId);
      } else {
        newSet.add(sectionId);
      }
      return newSet;
    });
  }, []);

  // Product name change handler
  const handleProductNameChange = useCallback((event: React.ChangeEvent<HTMLInputElement>) => {
    const value = event.target.value || '';
    const uppercaseValue = value.toUpperCase();
    // Prevent extremely long strings that could cause URL issues
    if (uppercaseValue.length <= 200) {
      setProductName(uppercaseValue);
    }
  }, []);

  // Export to PDF
  const exportToPDF = useCallback(async (): Promise<void> => {
    if (!smartCuttingList) return;

    console.log('üîÑ PDF Export ba≈ülatƒ±lƒ±yor...', { cuttingListId: smartCuttingList.id, title: smartCuttingList.title });
    console.log('üìã Cutting List Data:', JSON.stringify(smartCuttingList, null, 2));
    setLoadingState(LoadingState.LOADING);
    
    try {
      console.log('üì§ Backend\'e PDF export isteƒüi g√∂nderiliyor...');
      const response = await axios.post(
        'http://localhost:3001/api/cutting-list/export/pdf',
        { cuttingList: smartCuttingList },
        { 
          responseType: 'blob',
          timeout: 120000 // 2 dakika timeout
        }
      );
      
      console.log('‚úÖ PDF export ba≈üarƒ±lƒ±, dosya boyutu:', response.data.size);
      
      // Validate PDF data
      if (!response.data || response.data.size === 0) {
        throw new Error('PDF dosyasƒ± bo≈ü veya ge√ßersiz');
      }
      
      const blob = new Blob([response.data], { type: 'application/pdf' });
      
      // Validate blob
      if (blob.size === 0) {
        throw new Error('PDF blob olu≈üturulamadƒ±');
      }
      
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${smartCuttingList.title.replace(/[^a-zA-Z0-9\s]/g, '')}_${smartCuttingList.weekNumber}_hafta.pdf`;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      
      // Cleanup
      setTimeout(() => {
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
      }, 100);
      
      setSuccess('PDF ba≈üarƒ±yla indirildi');
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      console.error('‚ùå PDF Export hatasƒ±:', error);
      
      if (axios.isAxiosError(error)) {
        console.error('‚ùå Axios Error Details:', {
          status: error.response?.status,
          statusText: error.response?.statusText,
          data: error.response?.data,
          message: error.message,
          code: error.code,
          config: {
            url: error.config?.url,
            method: error.config?.method,
            timeout: error.config?.timeout
          }
        });
        
        // Error response'u parse et
        if (error.response?.data) {
          try {
            const errorData = typeof error.response.data === 'string' 
              ? JSON.parse(error.response.data) 
              : error.response.data;
            
            console.error('‚ùå Backend Error Details:', errorData);
          } catch (parseError) {
            console.error('‚ùå Error response parse edilemedi:', error.response.data);
          }
        }
      }
      
      handleError(error, 'exportToPDF');
    }
  }, [smartCuttingList, handleError]);

  // Export to Excel
  const exportToExcel = useCallback(async (): Promise<void> => {
    if (!smartCuttingList) return;

    setLoadingState(LoadingState.LOADING);
    
    try {
      const response = await axios.post(
        'http://localhost:3001/api/cutting-list/export/excel',
        { cuttingList: smartCuttingList },
        { responseType: 'blob' }
      );
      
      const blob = new Blob([response.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${smartCuttingList.title.replace(/\s+/g, '_')}_${smartCuttingList.weekNumber}_hafta.xlsx`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
      
      setSuccess('Excel ba≈üarƒ±yla indirildi');
      setLoadingState(LoadingState.SUCCESS);
      
    } catch (error) {
      handleError(error, 'exportToExcel');
    }
  }, [smartCuttingList, handleError]);

  // Smart profile suggestions
  const getProfileSuggestions = useCallback(async (query: string): Promise<void> => {
    if (!query.trim()) {
      setProfileSuggestions([]);
      return;
    }

    try {
      const response = await axios.get<ApiResponse<string[]>>(
        `http://localhost:3001/api/cutting-list/profiles/suggestions?q=${encodeURIComponent(query)}`
      );
      
      if (response.data.success && response.data.data) {
        setProfileSuggestions(response.data.data);
      }
    } catch (error) {
      console.error('Profile suggestions error:', error);
    }
  }, []);

  // Smart measurement suggestions with context awareness
  const getMeasurementSuggestions = useCallback(async (
    profileType: string, 
    productName?: string, 
    size?: string
  ): Promise<void> => {
    if (!profileType.trim()) {
      setMeasurementSuggestions([]);
      return;
    }

    try {
      // Build query parameters for context-aware suggestions
      const params = new URLSearchParams({
        profileType: profileType.trim(),
        limit: '10'
      });

      if (productName?.trim()) {
        params.append('productName', productName.trim());
      }
      
      if (size?.trim()) {
        params.append('size', size.trim());
      }

      const response = await axios.get<ApiResponse<any>>(
        `http://localhost:3001/api/cutting-list/enterprise/measurements?${params.toString()}`
      );
      
      if (response.data.success && response.data.data) {
        // Handle both array and object responses
        const measurements = Array.isArray(response.data.data) 
          ? response.data.data 
          : response.data.data.data || [];
          
        setMeasurementSuggestions(measurements);
        
        // Log context insights if available
        if (response.data.data.contextInsights) {
          console.log('Context insights:', response.data.data.contextInsights);
        }
      }
    } catch (error) {
      // Fallback to basic suggestions if enterprise service fails
      try {
        const response = await axios.get<ApiResponse<string[]>>(
          `http://localhost:3001/api/cutting-list/profiles/${encodeURIComponent(profileType)}/measurements`
        );
        
        if (response.data.success && response.data.data) {
          setMeasurementSuggestions(response.data.data);
        }
      } catch (fallbackError) {
        console.error('Measurement suggestions error:', error);
      }
    }
  }, []);

  // Enterprise profile suggestions with advanced context awareness
  const getEnterpriseProfileSuggestions = useCallback(async (
    productName: string,
    size: string,
    note?: string,
    version?: string,
    color?: string
  ): Promise<void> => {
    if (!productName.trim() || !size.trim()) {
      setEnterpriseProfileSuggestions([]);
      setContextualInsights([]);
      return;
    }

    try {
      const params = new URLSearchParams({
        productName: productName.trim(),
        size: size.trim(),
        limit: '15'
      });

      if (note?.trim()) params.append('note', note.trim());
      if (version?.trim()) params.append('version', version.trim());
      if (color?.trim()) params.append('color', color.trim());

      const response = await axios.get<ApiResponse<any>>(
        `http://localhost:3001/api/cutting-list/enterprise/profiles?${params.toString()}`
      );
      
      if (response.data.success && response.data.data) {
        const analysisResult = response.data.data;
        
        setEnterpriseProfileSuggestions(analysisResult.suggestions || []);
        setContextualInsights(analysisResult.contextualInsights || []);
        
        console.log('üß† Enterprise suggestions loaded:', analysisResult.suggestions?.length || 0);
        console.log('üí° Contextual insights:', analysisResult.contextualInsights);
        
        // Debug: Log the suggestions details
        if (analysisResult.suggestions?.length > 0) {
          console.log('üìä Suggestion details:', analysisResult.suggestions.map((s: { profile: string; measurement: string; confidence: number }) => 
            `${s.profile} - ${s.measurement}mm (${s.confidence}%)`
          ));
        }
        
        // Also set basic profile suggestions for compatibility
        if (analysisResult.suggestions?.length > 0) {
          const basicProfiles = analysisResult.suggestions
            .map((s: { profile: string }) => s.profile)
            .filter((profile: string, index: number, arr: string[]) => arr.indexOf(profile) === index)
            .slice(0, 8);
          setProfileSuggestions(basicProfiles);
        }
      }
    } catch (error) {
      console.error('Enterprise profile suggestions error:', error);
      // Clear enterprise suggestions on error
      setEnterpriseProfileSuggestions([]);
      setContextualInsights([]);
    }
  }, []);

  // Get product name suggestions from existing cutting lists
  const getProductNameSuggestions = useCallback((query: string): void => {
    if (!query.trim() || query.length < 2) {
      setProductNameSuggestions([]);
      return;
    }

    // Collect all unique product names from all cutting lists
    const allProductNames = new Set<string>();
    
    // Add from current cutting list
    if (smartCuttingList?.sections) {
      smartCuttingList.sections.forEach((section: SmartProductSection) => {
        if (section.productName) {
          allProductNames.add(section.productName);
        }
      });
    }
    
    // Add from all cutting lists
    smartCuttingLists.forEach((list: SmartCuttingList) => {
      list.sections?.forEach((section: SmartProductSection) => {
        if (section.productName) {
          allProductNames.add(section.productName);
        }
      });
    });

    // Filter suggestions based on query
    const queryUpper = query.toUpperCase();
    const suggestions = Array.from(allProductNames)
      .filter(name => name.toUpperCase().includes(queryUpper))
      .sort((a, b) => {
        // Prioritize exact matches at the beginning
        const aStartsWith = a.toUpperCase().startsWith(queryUpper);
        const bStartsWith = b.toUpperCase().startsWith(queryUpper);
        
        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;
        
        return a.localeCompare(b);
      })
      .slice(0, 8); // Limit to 8 suggestions

    setProductNameSuggestions(suggestions);
  }, [smartCuttingList, smartCuttingLists]);

  // Get available sizes for a product
  const getAvailableSizes = useCallback(async (productName: string): Promise<void> => {
    if (!productName.trim()) {
      setAvailableSizes([]);
      return;
    }

    try {
      const response = await axios.get(`http://localhost:3001/api/cutting-list/enterprise/product-sizes?productName=${encodeURIComponent(productName)}`);
      if (response.data.success && response.data.data.sizes) {
        setAvailableSizes(response.data.data.sizes);
        console.log(`üìè Found ${response.data.data.sizes.length} sizes for ${productName}`);
      } else {
        setAvailableSizes([]);
      }
    } catch (error) {
      console.error('Error getting available sizes:', error);
      setAvailableSizes([]);
    }
  }, []);

  // Get complete profile set for product-size combination with smart quantity calculation
  const getCompleteProfileSet = useCallback(async (productName: string, size: string, orderQuantity?: string): Promise<void> => {
    if (!productName.trim() || !size.trim()) {
      setCompleteProfileSet(null);
      return;
    }

    try {
      let url = `http://localhost:3001/api/cutting-list/enterprise/complete-profile-set?productName=${encodeURIComponent(productName)}&size=${encodeURIComponent(size)}`;
      
      // Sipari≈ü adedi varsa g√∂nder
      if (orderQuantity && parseInt(orderQuantity) > 0) {
        url += `&orderQuantity=${orderQuantity}`;
      }
      
      const response = await axios.get(url);
      if (response.data.success && response.data.data) {
        setCompleteProfileSet(response.data.data);
        const method = response.data.data.calculationMethod === 'user_specified' ? 'Kullanƒ±cƒ± Tanƒ±mlƒ±' : 'Ge√ßmi≈ü Ortalama';
        console.log(`üéØ Akƒ±llƒ± profil seti ${productName}|${size}:`);
        console.log(`   üìä Hesaplama: ${method}`);
        console.log(`   üì¶ Toplam: ${response.data.data.totalItems} profil`);
        console.log(`   üî¢ √ñnerilen toplam adet: ${response.data.data.averageTotalQuantity}`);
      } else {
        setCompleteProfileSet(null);
      }
    } catch (error) {
      console.error('Error getting complete profile set:', error);
      setCompleteProfileSet(null);
    }
  }, []);

  // Apply complete profile set to current item FORM (not directly to list)
  const applyCompleteProfileSet = useCallback((): void => {
    if (!completeProfileSet || !newItemForm.size) {
      console.warn('Cannot apply profile set: missing data or size');
      return;
    }

    try {
      // Create profiles array for the FORM (not for direct addition)
      const formProfiles: SmartProfileFormItem[] = completeProfileSet.profiles.map((profile, index) => ({
        id: `profile-${Date.now()}-${index}`,
        profile: profile.profile,
        measurement: profile.measurement,
        quantity: profile.suggestedQuantity.toString()
      }));

      // Update the FORM with complete profile set
      setNewItemForm(prev => ({
        ...prev,
        profiles: formProfiles,
        // Auto-fill order quantity if not set
        orderQuantity: prev.orderQuantity || completeProfileSet.averageTotalQuantity.toString()
      }));
      
      const totalCalculated = formProfiles.reduce((sum, p) => sum + parseInt(p.quantity), 0);
      setSuccess(`‚úÖ ${completeProfileSet.totalItems} profil forma eklendi! Toplam ${totalCalculated} adet hesaplandƒ±. (Sipari≈ü: ${newItemForm.orderQuantity || completeProfileSet.averageTotalQuantity} adet)`);
      console.log(`‚úÖ Applied complete profile set to form: ${completeProfileSet.totalItems} profiles`);
      
    } catch (error) {
      console.error('Error applying complete profile set:', error);
      handleError(new Error('Profil seti uygulanƒ±rken hata olu≈ütu'), 'applyCompleteProfileSet');
    }
  }, [completeProfileSet, newItemForm.size, setSuccess, handleError]);

  // Search for similar products when product name changes
  useEffect(() => {
    if (debouncedProductName && debouncedProductName.trim() && debouncedProductName.length < 100) {
      if (searchSimilarProducts) searchSimilarProducts(debouncedProductName);
      if (getSizesForProduct) getSizesForProduct(debouncedProductName);
      // Get product name suggestions from existing lists
      getProductNameSuggestions(debouncedProductName);
      // Get available sizes for this product
      getAvailableSizes(debouncedProductName);
    } else {
      if (clearSuggestions) clearSuggestions();
      setProductNameSuggestions([]);
      setAvailableSizes([]);
    }
  }, [debouncedProductName, searchSimilarProducts, getSizesForProduct, clearSuggestions, getProductNameSuggestions, getAvailableSizes]);

  // Calculate total quantity
  const calculateTotalQuantity = useCallback((): void => {
    const total = newItemForm.profiles.reduce((sum, profile) => {
      const quantity = parseInt(profile.quantity) || 0;
      return sum + quantity;
    }, 0);
    setTotalQuantityCalculation(total);
  }, [newItemForm.profiles]);

  // Update calculation when profiles change
  useEffect(() => {
    calculateTotalQuantity();
  }, [calculateTotalQuantity]);

  // Handle profile changes with enterprise smart suggestions
  const handleProfileChange = useCallback((profileId: string, field: keyof SmartProfileFormItem, value: string) => {
    setNewItemForm(prev => {
      const uppercaseValue = (field === 'measurement' || field === 'quantity') ? value : value.toUpperCase();
      
      const updatedProfiles = prev.profiles.map(profile => 
        profile.id === profileId ? { ...profile, [field]: uppercaseValue } : profile
      );
      
      // Trigger smart suggestions with context
      if (field === 'profile' && uppercaseValue.length > 1) {
        getProfileSuggestions(uppercaseValue);
        
        // Get context-aware enterprise suggestions if we have product info
        const currentSection = smartCuttingList?.sections.find((s: SmartProductSection) => s.id === currentSectionId);
        if (currentSection?.productName && prev.size) {
          // Use setTimeout to ensure function is available
          setTimeout(() => {
            getEnterpriseProfileSuggestions(
              currentSection.productName,
              prev.size,
              prev.note,
              prev.version,
              prev.color
            );
          }, 0);
        }
      }
      
      if (field === 'profile' && uppercaseValue.length > 2) {
        // Get context-aware measurement suggestions
        const currentSection = smartCuttingList?.sections.find((s: SmartProductSection) => s.id === currentSectionId);
        getMeasurementSuggestions(
          uppercaseValue,
          currentSection?.productName,
          prev.size
        );
      }
      
      return { ...prev, profiles: updatedProfiles };
    });
  }, [getProfileSuggestions, getMeasurementSuggestions, smartCuttingList, currentSectionId]);

  // Copy item to clipboard
  const copyItemToClipboard = useCallback((item: SmartWorkOrder) => {
    const text = `ƒ∞≈ü Emri: ${item.workOrderId}
Tarih: ${item.date}
Versiyon: ${item.version}
Renk: ${item.color}
Sipari≈ü Adedi: ${item.orderQuantity}
Ebat: ${item.size}
Profiller:
${item.profiles.map((p: SmartProfileItem) => `- ${p.profile || 'N/A'}: ${p.measurement} (${p.quantity} adet)`).join('\n')}`;
    
    navigator.clipboard.writeText(text);
    setSuccess('ƒ∞≈ü emri panoya kopyalandƒ±');
  }, []);

  // ============================================================================
  // MODERN UI RENDER
  // ============================================================================

  return (
    <ErrorBoundary>
      <GradientBackground>
        <Container maxWidth="xl" sx={{ position: 'relative', zIndex: 1 }}>
          <AnimatedContainer>
            {/* Modern Header */}
            <ModernCard sx={{ mb: 4, background: 'rgba(255, 255, 255, 0.95)', backdropFilter: 'blur(20px)' }}>
              <CardContent sx={{ p: 4 }}>
                <Stack direction="row" alignItems="center" justifyContent="space-between" sx={{ mb: 3 }}>
                  <Stack direction="row" alignItems="center" spacing={3}>
                    <Avatar sx={{ 
                      bgcolor: 'primary.main', 
                      width: 64, 
                      height: 64,
                      boxShadow: '0 8px 32px rgba(33, 150, 243, 0.3)'
                    }}>
                      <RocketIcon sx={{ fontSize: 32 }} />
                    </Avatar>
                    <Box>
                      <Typography variant="h3" sx={{ 
                        fontWeight: 800, 
                        mb: 1,
                        background: 'linear-gradient(45deg, #1976d2 30%, #42a5f5 90%)',
                        backgroundClip: 'text',
                        WebkitBackgroundClip: 'text',
                        WebkitTextFillColor: 'transparent',
                        fontSize: { xs: '1.75rem', md: '2.25rem', lg: '2.75rem' }
                      }}>
                        Yeni ƒ∞≈ü Emri Olu≈üturma Merkezi
                      </Typography>
                      <Typography variant="h6" sx={{ 
                        color: 'text.secondary',
                        fontSize: { xs: '0.875rem', md: '1.125rem' },
                        fontWeight: 400
                      }}>
                        üöÄ AI Destekli ‚Ä¢ ‚ö° Tek Tu≈üla Ekleme ‚Ä¢ üß† Akƒ±llƒ± √ñneriler
                      </Typography>
                    </Box>
                  </Stack>
                  
                  {/* Smart Stats */}
                  <Stack direction="row" spacing={3} sx={{ display: { xs: 'none', lg: 'flex' } }}>
                    <Box textAlign="center">
                      <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5, color: 'primary.main' }}>
                        {smartCuttingList?.totalWorkOrders || 0}
                      </Typography>
                      <Typography variant="caption" sx={{ color: 'text.secondary' }}>
                        Toplam ƒ∞≈ü Emri
                      </Typography>
                    </Box>
                    <Box textAlign="center">
                      <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5, color: 'success.main' }}>
                        {Math.round(suggestionConfidence)}%
                      </Typography>
                      <Typography variant="caption" sx={{ color: 'text.secondary' }}>
                        AI G√ºven Oranƒ±
                      </Typography>
                    </Box>
                    <Box textAlign="center">
                      <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5, color: 'warning.main' }}>
                        {smartSuggestions.length}
                      </Typography>
                      <Typography variant="caption" sx={{ color: 'text.secondary' }}>
                        Akƒ±llƒ± √ñneri
                      </Typography>
                    </Box>
                  </Stack>
                </Stack>

                {/* Smart Action Bar */}
                <Stack direction="row" spacing={2} alignItems="center" justifyContent="space-between">
                  <Stack direction="row" spacing={2}>
                    <SmartButton
                      variant="contained"
                      startIcon={<FlashOnIcon />}
                      onClick={() => setActiveTab(0)}
                      sx={{
                        background: activeTab === 0 ? 'linear-gradient(45deg, #FF6B6B 30%, #FF8E53 90%)' : 'transparent',
                        color: activeTab === 0 ? 'white' : 'primary.main',
                        border: '2px solid',
                        borderColor: 'primary.main'
                      }}
                    >
                      Hƒ±zlƒ± Olu≈ütur
                    </SmartButton>
                    <SmartButton
                      variant="contained"
                      startIcon={<TouchAppIcon />}
                      onClick={() => setActiveTab(1)}
                      sx={{
                        background: activeTab === 1 ? 'linear-gradient(45deg, #4ECDC4 30%, #44A08D 90%)' : 'transparent',
                        color: activeTab === 1 ? 'white' : 'primary.main',
                        border: '2px solid',
                        borderColor: 'primary.main'
                      }}
                    >
                      Akƒ±llƒ± √ñneriler
                    </SmartButton>
                    <SmartButton
                      variant="contained"
                      startIcon={<SpeedIcon />}
                      onClick={() => setActiveTab(2)}
                      sx={{
                        background: activeTab === 2 ? 'linear-gradient(45deg, #667eea 30%, #764ba2 90%)' : 'transparent',
                        color: activeTab === 2 ? 'white' : 'primary.main',
                        border: '2px solid',
                        borderColor: 'primary.main'
                      }}
                    >
                      Toplu ƒ∞≈ülemler
                    </SmartButton>
                  </Stack>

                  {/* View Mode Toggle */}
                  <ToggleButtonGroup
                    value={viewMode}
                    exclusive
                    onChange={(_, newMode) => newMode && setViewMode(newMode)}
                    size="small"
                  >
                    <ToggleButton value="grid">
                      <GridViewIcon />
                    </ToggleButton>
                    <ToggleButton value="list">
                      <ViewListIcon />
                    </ToggleButton>
                    <ToggleButton value="timeline">
                      <TimelineIcon />
                    </ToggleButton>
                  </ToggleButtonGroup>
                </Stack>
              </CardContent>
            </ModernCard>

            {/* Main Content Area */}
            <Grid container spacing={4}>
              {/* Left Sidebar - Smart Suggestions */}
              <Grid item xs={12} lg={4}>
                <ModernCard sx={{ 
                  height: 'fit-content',
                  position: 'sticky',
                  top: 24,
                  background: 'rgba(255, 255, 255, 0.95)',
                  backdropFilter: 'blur(20px)'
                }}>
                  <CardContent sx={{ p: 3 }}>
                    <Stack direction="row" alignItems="center" spacing={2} sx={{ mb: 3 }}>
                      <Avatar sx={{ bgcolor: 'primary.main', width: 40, height: 40 }}>
                        <LightbulbIcon />
                      </Avatar>
                      <Box>
                        <Typography variant="h6" sx={{ fontWeight: 700 }}>
                          üß† Akƒ±llƒ± √ñneriler
                        </Typography>
                        <Typography variant="caption" sx={{ color: 'text.secondary' }}>
                          AI destekli profil √∂nerileri
                        </Typography>
                      </Box>
                    </Stack>

                    {/* AI Analysis Status */}
                    {isAIAnalyzing && (
                      <Box sx={{ mb: 3 }}>
                        <Stack direction="row" alignItems="center" spacing={2}>
                          <CircularProgress size={20} />
                          <Typography variant="body2" sx={{ color: 'text.secondary' }}>
                            AI analiz ediyor...
                          </Typography>
                        </Stack>
                        <LinearProgress sx={{ mt: 1 }} />
                      </Box>
                    )}

                    {/* Smart Suggestions List */}
                    <Stack spacing={2}>
                      {smartSuggestions.map((suggestion, index) => (
                        <Zoom in={true} timeout={300 + index * 100} key={suggestion.id}>
                          <Paper
                            elevation={2}
                            sx={{
                              p: 2,
                              borderRadius: 2,
                              border: '1px solid',
                              borderColor: suggestion.confidence > 80 ? 'success.main' : 
                                          suggestion.confidence > 60 ? 'warning.main' : 'error.main',
                              background: suggestion.confidence > 80 ? 
                                'linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(76, 175, 80, 0.05) 100%)' :
                                suggestion.confidence > 60 ?
                                'linear-gradient(135deg, rgba(255, 152, 0, 0.1) 0%, rgba(255, 152, 0, 0.05) 100%)' :
                                'linear-gradient(135deg, rgba(244, 67, 54, 0.1) 0%, rgba(244, 67, 54, 0.05) 100%)',
                              cursor: 'pointer',
                              transition: 'all 0.3s ease',
                              '&:hover': {
                                transform: 'translateY(-2px)',
                                boxShadow: '0 8px 25px rgba(0, 0, 0, 0.15)',
                              }
                            }}
                            onClick={() => {
                              if (suggestion.type === 'complete_set') {
                                applySmartProfileSet(suggestion);
                              } else {
                                quickAddProfile(suggestion);
                              }
                            }}
                          >
                            <Stack direction="row" alignItems="center" justifyContent="space-between">
                              <Box sx={{ flex: 1 }}>
                                <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 0.5 }}>
                                  {suggestion.value}
                                </Typography>
                                <Typography variant="caption" sx={{ color: 'text.secondary' }}>
                                  {suggestion.context || 'AI √∂nerisi'}
                                </Typography>
                              </Box>
                              <Stack alignItems="center" spacing={1}>
                                <Chip
                                  label={`%${suggestion.confidence}`}
                                  size="small"
                                  color={suggestion.confidence > 80 ? 'success' : 
                                         suggestion.confidence > 60 ? 'warning' : 'error'}
                                  sx={{ fontWeight: 600 }}
                                />
                                <IconButton size="small" color="primary">
                                  <TouchAppIcon fontSize="small" />
                                </IconButton>
                              </Stack>
                            </Stack>
                          </Paper>
                        </Zoom>
                      ))}
                    </Stack>

                    {/* Smart Insights */}
                    {smartInsights.length > 0 && (
                      <Box sx={{ mt: 3 }}>
                        <Typography variant="subtitle2" sx={{ fontWeight: 600, mb: 2 }}>
                          üí° Akƒ±llƒ± ƒ∞√ßg√∂r√ºler
                        </Typography>
                        <Stack spacing={1}>
                          {smartInsights.map((insight) => (
                            <Alert
                              key={insight.id}
                              severity={insight.severity}
                              sx={{ borderRadius: 2 }}
                              action={
                                insight.actionable && (
                                  <Button size="small" color="inherit">
                                    {insight.action}
                                  </Button>
                                )
                              }
                            >
                              <Typography variant="caption">
                                {insight.message}
                              </Typography>
                            </Alert>
                          ))}
                        </Stack>
                      </Box>
                    )}
                  </CardContent>
                </ModernCard>
              </Grid>

              {/* Main Content - Tab System */}
              <Grid item xs={12} lg={8}>
                <ModernCard sx={{ 
                  background: 'rgba(255, 255, 255, 0.95)',
                  backdropFilter: 'blur(20px)'
                }}>
                  <CardContent sx={{ p: 0 }}>
                    <Tabs
                      value={activeTab}
                      onChange={(_, newValue) => setActiveTab(newValue)}
                      variant="fullWidth"
                      sx={{
                        borderBottom: 1,
                        borderColor: 'divider',
                        '& .MuiTab-root': {
                          textTransform: 'none',
                          fontWeight: 600,
                          py: 2,
                        }
                      }}
                    >
                      <Tab
                        icon={<FlashOnIcon />}
                        label="Hƒ±zlƒ± Olu≈ütur"
                        iconPosition="start"
                      />
                      <Tab
                        icon={<TouchAppIcon />}
                        label="Akƒ±llƒ± √ñneriler"
                        iconPosition="start"
                      />
                      <Tab
                        icon={<SpeedIcon />}
                        label="Toplu ƒ∞≈ülemler"
                        iconPosition="start"
                      />
                    </Tabs>

                    {/* Tab Content */}
                    <Box sx={{ p: 4 }}>
                      {activeTab === 0 && (
                        <Fade in={activeTab === 0} timeout={300}>
                          <Box>
                            {/* Quick Create Form */}
                            <Typography variant="h5" sx={{ fontWeight: 700, mb: 3 }}>
                              ‚ö° Hƒ±zlƒ± ƒ∞≈ü Emri Olu≈üturma
                            </Typography>
                            
                            <Grid container spacing={3}>
                              <Grid item xs={12} md={6}>
                                <SmartTextField
                                  fullWidth
                                  label="ƒ∞≈ü Emri No"
                                  value={newItemForm.workOrderId}
                                  onChange={(e) => setNewItemForm(prev => ({ ...prev, workOrderId: e.target.value }))}
                                  InputProps={{
                                    startAdornment: (
                                      <InputAdornment position="start">
                                        <AssignmentIcon color="primary" />
                                      </InputAdornment>
                                    ),
                                  }}
                                />
                              </Grid>
                              <Grid item xs={12} md={6}>
                                <SmartTextField
                                  fullWidth
                                  type="date"
                                  label="Tarih"
                                  value={newItemForm.date}
                                  onChange={(e) => setNewItemForm(prev => ({ ...prev, date: e.target.value }))}
                                  InputLabelProps={{ shrink: true }}
                                />
                              </Grid>
                              <Grid item xs={12} md={4}>
                                <SmartTextField
                                  fullWidth
                                  label="Versiyon"
                                  value={newItemForm.version}
                                  onChange={(e) => setNewItemForm(prev => ({ ...prev, version: e.target.value }))}
                                />
                              </Grid>
                              <Grid item xs={12} md={4}>
                                <SmartTextField
                                  fullWidth
                                  label="Renk"
                                  value={newItemForm.color}
                                  onChange={(e) => setNewItemForm(prev => ({ ...prev, color: e.target.value }))}
                                />
                              </Grid>
                              <Grid item xs={12} md={4}>
                                <FormControl fullWidth>
                                  <InputLabel>√ñncelik</InputLabel>
                                  <Select
                                    value={newItemForm.priority}
                                    onChange={(e) => setNewItemForm(prev => ({ ...prev, priority: e.target.value as 'low' | 'medium' | 'high' | 'urgent' }))}
                                    label="√ñncelik"
                                  >
                                    <MenuItem value="low">üü¢ D√º≈ü√ºk</MenuItem>
                                    <MenuItem value="medium">üü° Orta</MenuItem>
                                    <MenuItem value="high">üü† Y√ºksek</MenuItem>
                                    <MenuItem value="urgent">üî¥ Acil</MenuItem>
                                  </Select>
                                </FormControl>
                              </Grid>
                            </Grid>
                          </Box>
                        </Fade>
                      )}

                      {activeTab === 1 && (
                        <Fade in={activeTab === 1} timeout={300}>
                          <Box>
                            <Typography variant="h5" sx={{ fontWeight: 700, mb: 3 }}>
                              üß† Akƒ±llƒ± √ñneri Merkezi
                            </Typography>
                            {/* Smart suggestions content will be here */}
                          </Box>
                        </Fade>
                      )}

                      {activeTab === 2 && (
                        <Fade in={activeTab === 2} timeout={300}>
                          <Box>
                            <Typography variant="h5" sx={{ fontWeight: 700, mb: 3 }}>
                              ‚ö° Toplu ƒ∞≈ülem Merkezi
                            </Typography>
                            {/* Bulk operations content will be here */}
                          </Box>
                        </Fade>
                      )}
                    </Box>
                  </CardContent>
                </ModernCard>
              </Grid>
            </Grid>

            {/* Floating Action Button */}
            <FloatingActionButton
              color="primary"
              onClick={() => {
                // Quick add new work order
                setNewItemForm({
                  workOrderId: `WO-${Date.now()}`,
                  date: new Date().toISOString().split('T')[0],
                  version: '1.0',
                  color: '',
                  note: '',
                  orderQuantity: '1',
                  size: '',
                  priority: 'medium',
                  profiles: []
                });
                setActiveTab(0);
              }}
            >
              <AddIcon />
            </FloatingActionButton>
          </AnimatedContainer>
        </Container>
      </GradientBackground>

      {/* Loading Bar */}
        {loadingState === LoadingState.LOADING && (
          <>
            <LinearProgress sx={{ position: 'fixed', top: 0, left: 0, right: 0, zIndex: 9999 }} />
            <Box sx={{ 
              position: 'fixed', 
              top: 4, 
              right: 16, 
              zIndex: 10000,
              backgroundColor: 'rgba(255, 255, 255, 0.9)',
              padding: '4px 12px',
              borderRadius: 1,
              fontSize: '0.875rem',
              color: 'primary.main'
            }}>
              Sistem ba≈ülatƒ±lƒ±yor...
            </Box>
          </>
        )}

        {/* Auto-save indicator */}
        {isAutoSaving && loadingState === LoadingState.SUCCESS && (
          <Chip
            label="Otomatik kaydediliyor..."
            size="small"
            sx={{ position: 'fixed', top: 10, right: 10, zIndex: 9998 }}
            icon={<CircularProgress size={12} />}
          />
        )}

        {/* Executive Header */}
        <Card
          elevation={0}
          sx={{
            mb: 4,
            background: gradients.primary,
            color: 'white',
            borderRadius: 3,
            position: 'relative',
            overflow: 'hidden',
            '&::before': {
              content: '""',
              position: 'absolute',
              top: 0,
              right: 0,
              width: '200px',
              height: '100%',
              background: 'linear-gradient(45deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05))',
              borderRadius: '0 0 0 100%'
            }
          }}
        >
          <CardContent sx={{ p: responsiveSpacing.card, position: 'relative', zIndex: 1 }}>
            <Stack direction="row" alignItems="center" justifyContent="space-between">
              <Stack direction="row" alignItems="center" spacing={3}>
                <Avatar sx={{ 
                  bgcolor: 'rgba(255, 255, 255, 0.2)', 
                  width: 64, 
                  height: 64,
                  border: '2px solid rgba(255, 255, 255, 0.3)'
                }}>
                  <AssignmentIcon sx={{ fontSize: 32 }} />
                </Avatar>
                <Box>
                  <Typography variant="h3" sx={{ 
                    fontWeight: 800, 
                    mb: 0.5,
                    fontSize: { xs: '1.75rem', md: '2.25rem', lg: '2.75rem' },
                    letterSpacing: '-0.025em'
                  }}>
                    Kesim Listesi Y√∂netimi
                  </Typography>
                  <Typography variant="h6" sx={{ 
                    opacity: 0.9,
                    fontSize: { xs: '0.875rem', md: '1.125rem' },
                    fontWeight: 400
                  }}>
                    Akƒ±llƒ± √úretim Planlama & Y√∂netim Sistemi
                  </Typography>
                  <Typography variant="body2" sx={{ 
                    opacity: 0.8,
                    fontSize: { xs: '0.75rem', md: '0.875rem' },
                    fontWeight: 300,
                    mt: 0.5
                  }}>
                    üß† AI Destekli ‚Ä¢ üìä Ge√ßmi≈ü Veri Analizi ‚Ä¢ ‚ö° Otomatik Hesaplama
                  </Typography>
                </Box>
              </Stack>
              
              {cuttingListStats && (
                <Stack direction="row" spacing={3} sx={{ display: { xs: 'none', md: 'flex' } }}>
                  <Box textAlign="center">
                    <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
                      {cuttingListStats.totalSections}
                    </Typography>
                    <Typography variant="caption" sx={{ opacity: 0.8 }}>
                      √úr√ºn Kategorisi
                    </Typography>
                  </Box>
                  <Box textAlign="center">
                    <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
                      {cuttingListStats.totalItems}
                    </Typography>
                    <Typography variant="caption" sx={{ opacity: 0.8 }}>
                      ƒ∞≈ü Emri
                    </Typography>
                  </Box>
                  <Box textAlign="center">
                    <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
                      {cuttingListStats.totalProfiles}
                    </Typography>
                    <Typography variant="caption" sx={{ opacity: 0.8 }}>
                      Profil Tipi
                    </Typography>
                  </Box>
                </Stack>
              )}
            </Stack>
          </CardContent>
        </Card>

        {/* Error Display */}
        {error && (
          <Alert severity="error" sx={{ mb: 3 }} onClose={() => setError(null)}>
            <Typography variant="body2" sx={{ fontWeight: 600 }}>
              {error}
            </Typography>
          </Alert>
        )}

        {/* Success Snackbar */}
        <Snackbar
          open={!!success}
          autoHideDuration={3000}
          onClose={() => setSuccess(null)}
          anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}
        >
          <Alert onClose={() => setSuccess(null)} severity="success" sx={{ width: '100%' }}>
            {success}
          </Alert>
        </Snackbar>

        {/* Create New Cutting List */}
        {!smartCuttingList && (
          <Card sx={{ mb: 3 }}>
            <CardContent>
              <Typography variant="h6" sx={{ mb: 2, display: 'flex', alignItems: 'center', gap: 1 }}>
                <CategoryIcon color="primary" />
                Yeni Kesim Listesi Olu≈ütur
              </Typography>
              <Alert severity="info" sx={{ mb: 2 }}>
                <Typography variant="body2">
                  <strong>Bilgi:</strong> Hafta numarasƒ±nƒ± deƒüi≈ütirerek istediƒüiniz hafta i√ßin kesim listesi olu≈üturabilirsiniz. Ba≈ülƒ±k otomatik olarak "{selectedWeekNumber}. HAFTA KESƒ∞M Lƒ∞STESƒ∞" formatƒ±nda olu≈üturulur.
                </Typography>
              </Alert>
              <Grid container spacing={2}>
                <Grid item xs={12} md={6}>
                  <TextField
                    fullWidth
                    size="medium"
                    label="Kesim Listesi Ba≈ülƒ±ƒüƒ±"
                    placeholder="Otomatik olu≈üturulur"
                    value={title}
                    onChange={(e) => setTitle(e.target.value)}
                    variant="outlined"
                    InputProps={{
                      readOnly: true,
                    }}
                    helperText="Hafta numarasƒ±na g√∂re otomatik olu≈üturulur"
                    sx={{
                      '& .MuiInputBase-input': {
                        backgroundColor: 'rgba(0, 0, 0, 0.04)',
                        cursor: 'default'
                      }
                    }}
                  />
                </Grid>
                <Grid item xs={12} md={3}>
                  <TextField
                    fullWidth
                    size="medium"
                    label="Hafta Numarasƒ±"
                    type="number"
                    value={selectedWeekNumber}
                    onChange={(e) => {
                      const newWeekNumber = parseInt(e.target.value) || getCurrentWeekNumber();
                      setSelectedWeekNumber(newWeekNumber);
                      // Title will be automatically updated via useEffect
                    }}
                    variant="outlined"
                    inputProps={{ min: 1, max: 53 }}
                    helperText={
                      smartCuttingLists.find(list => list.weekNumber === selectedWeekNumber) 
                        ? `‚ö†Ô∏è ${selectedWeekNumber}. hafta zaten mevcut!` 
                        : `Mevcut hafta: ${getCurrentWeekNumber()}`
                    }
                    error={!!smartCuttingLists.find(list => list.weekNumber === selectedWeekNumber)}
                  />
                </Grid>
                <Grid item xs={12} md={3}>
                  <Button
                    fullWidth
                    variant="contained"
                    size="medium"
                    startIcon={<AddIcon />}
                    onClick={createCuttingList}
                    disabled={
                      loading || 
                      !title.trim() || 
                      !!smartCuttingLists.find(list => list.weekNumber === selectedWeekNumber)
                    }
                    sx={{ height: 56 }}
                  >
                    Kesim Listesi Olu≈ütur
                  </Button>
                </Grid>
              </Grid>
            </CardContent>
          </Card>
        )}

        {/* Past Weeks */}
        {!smartCuttingList && smartCuttingLists.length > 0 && (
          <Card sx={{ mb: 3 }}>
            <CardContent>
              <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                <Typography variant="h6" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                  <ListIcon color="primary" />
                  Ge√ßmi≈ü Haftalar
                </Typography>
              </Box>
              
              {smartCuttingLists.find(list => list.weekNumber === getCurrentWeekNumber()) && (
                <Alert severity="info" sx={{ mb: 2 }}>
                  <Typography variant="body2">
                    <strong>{getCurrentWeekNumber()}. Hafta</strong> i√ßin zaten bir kesim listesi mevcut.
                  </Typography>
                </Alert>
              )}
             
              <Grid container spacing={2}>
                {sortedCuttingLists.map((list) => (
                  <Grid item xs={12} md={6} lg={4} key={list.id}>
                    <Card 
                      variant="outlined" 
                      sx={{ 
                        height: '100%',
                        border: list.weekNumber === getCurrentWeekNumber() ? '2px solid #1976d2' : '1px solid #e0e0e0',
                        bgcolor: list.weekNumber === getCurrentWeekNumber() ? '#f3f6ff' : 'transparent',
                        transition: 'all 0.3s ease',
                        '&:hover': {
                          transform: 'translateY(-4px)',
                          boxShadow: 3
                        }
                      }}
                    >
                      <CardContent>
                        <Stack spacing={1}>
                          <Box display="flex" justifyContent="space-between" alignItems="flex-start">
                            <Typography variant="h6" color="primary" sx={{ fontWeight: 600, fontSize: '1rem' }}>
                              {list.title}
                            </Typography>
                            <Chip 
                              label={`${list.weekNumber}. Hafta`} 
                              size="small" 
                              color={list.weekNumber === getCurrentWeekNumber() ? "primary" : "secondary"}
                              variant={list.weekNumber === getCurrentWeekNumber() ? "filled" : "outlined"}
                            />
                          </Box>
                          <Typography variant="body2" color="text.secondary">
                            {new Date(list.createdAt).toLocaleDateString('tr-TR')}
                          </Typography>
                          <Typography variant="body2" color="text.secondary">
                            {list.sections?.length || 0} √ºr√ºn ‚Ä¢ {list.sections?.reduce((total, section) => total + (section.items?.length || 0), 0) || 0} i≈ü emri
                          </Typography>
                          
                          <Box display="flex" gap={1}>
                            <Button
                              size="medium"
                              variant={list.weekNumber === currentWeekNumber ? "contained" : "outlined"}
                              startIcon={<ListIcon />}
                              onClick={() => setSmartCuttingList(list)}
                              fullWidth
                            >
                              {list.weekNumber === currentWeekNumber ? "Devam Et" : "G√∂r√ºnt√ºle"}
                            </Button>
                            <IconButton
                              size="medium"
                              color="error"
                              onClick={() => {
                                if (window.confirm('Bu kesim listesini kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?')) {
                                  const updatedLists = smartCuttingLists.filter((l: SmartCuttingList) => l.id !== list.id);
                                  setSmartCuttingLists(updatedLists);
                                  setSuccess('Kesim listesi silindi');
                                }
                              }}
                            >
                              <DeleteIcon fontSize="small" />
                            </IconButton>
                          </Box>
                        </Stack>
                      </CardContent>
                    </Card>
                  </Grid>
                ))}
              </Grid>
            </CardContent>
          </Card>
        )}

        {/* Executive Cutting List Dashboard */}
        {smartCuttingList && (
          <Card sx={{ mb: 4, elevation: 2 }}>
            <CardContent sx={{ p: 3 }}>
              {/* Header with Title and Actions */}
              <Stack direction="row" justifyContent="space-between" alignItems="flex-start" sx={{ mb: 3 }}>
                <Box flex={1}>
                  <Stack direction="row" alignItems="center" spacing={2} sx={{ mb: 2 }}>
                    <Avatar sx={{ bgcolor: 'primary.main', width: 48, height: 48 }}>
                      <DashboardIcon />
                    </Avatar>
                    <Box>
                      <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
                        {smartCuttingList.title}
                      </Typography>
                      <Stack direction="row" spacing={2} alignItems="center">
                        <Chip 
                          label={`${smartCuttingList.weekNumber}. Hafta`} 
                          size="small" 
                          color="primary" 
                          variant="filled"
                        />
                        <Typography variant="body2" color="text.secondary">
                          Son G√ºncelleme: {new Date(smartCuttingList.updatedAt).toLocaleDateString('tr-TR')}
                        </Typography>
                      </Stack>
                    </Box>
                  </Stack>
                </Box>

                {/* Executive Action Bar */}
                <Stack direction="row" spacing={1}>
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={<ListIcon />}
                    onClick={() => setSmartCuttingList(null)}
                    sx={{ 
                      textTransform: 'none',
                      borderColor: 'grey.300',
                      color: 'text.secondary'
                    }}
                  >
                    Ge√ßmi≈ü Haftalara D√∂n
                  </Button>
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={<PdfIcon />}
                    onClick={exportToPDF}
                    disabled={loading}
                    color="error"
                    sx={{ textTransform: 'none' }}
                  >
                    PDF ƒ∞ndir
                  </Button>
                  <Button
                    variant="outlined"
                    size="small"
                    startIcon={<ExcelIcon />}
                    onClick={exportToExcel}
                    disabled={loading}
                    color="success"
                    sx={{ textTransform: 'none' }}
                  >
                    Excel ƒ∞ndir
                  </Button>
                  <Button
                    variant="contained"
                    size="small"
                    startIcon={<SaveIcon />}
                    onClick={autoSaveCuttingList}
                    disabled={isAutoSaving}
                    sx={{ textTransform: 'none' }}
                  >
                    {isAutoSaving ? 'Kaydediliyor...' : 'Kaydet'}
                  </Button>
                </Stack>
              </Stack>

              {/* Executive Summary Cards */}
              <Grid container spacing={3} sx={{ mb: 3 }}>
                <Grid item xs={12} sm={6} md={3}>
                  <Card variant="outlined" sx={{ textAlign: 'center', p: 2 }}>
                    <InventoryIcon color="primary" sx={{ fontSize: 32, mb: 1 }} />
                    <Typography variant="h4" sx={{ fontWeight: 700, color: 'primary.main' }}>
                      {smartCuttingList.sections?.length || 0}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      √úr√ºn Kategorisi
                    </Typography>
                  </Card>
                </Grid>
                <Grid item xs={12} sm={6} md={3}>
                  <Card variant="outlined" sx={{ textAlign: 'center', p: 2 }}>
                    <AssignmentIcon color="info" sx={{ fontSize: 32, mb: 1 }} />
                    <Typography variant="h4" sx={{ fontWeight: 700, color: 'info.main' }}>
                      {smartCuttingList.sections?.reduce((total: number, section: SmartProductSection) => total + (section.items?.length || 0), 0) || 0}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      Toplam ƒ∞≈ü Emri
                    </Typography>
                  </Card>
                </Grid>
                <Grid item xs={12} sm={6} md={3}>
                  <Card variant="outlined" sx={{ textAlign: 'center', p: 2 }}>
                    <AnalyticsIcon color="success" sx={{ fontSize: 32, mb: 1 }} />
                    <Typography variant="h4" sx={{ fontWeight: 700, color: 'success.main' }}>
                      {smartCuttingList.sections?.reduce((total: number, section: SmartProductSection) => 
                        total + (section.items?.reduce((sum: number, item: SmartWorkOrder) => 
                          sum + (item.profiles?.length || 0), 0
                        ) || 0), 0
                      ) || 0}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      Profil √áe≈üidi
                    </Typography>
                  </Card>
                </Grid>
                <Grid item xs={12} sm={6} md={3}>
                  <Card variant="outlined" sx={{ textAlign: 'center', p: 2 }}>
                    <TrendingUpIcon color="warning" sx={{ fontSize: 32, mb: 1 }} />
                    <Typography variant="h4" sx={{ fontWeight: 700, color: 'warning.main' }}>
                      {Math.round(((smartCuttingList.sections?.reduce((total: number, section: SmartProductSection) => total + (section.items?.length || 0), 0) || 0) / Math.max(smartCuttingList.sections?.length || 1, 1)) * 10) / 10}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      Ortalama ƒ∞≈ü/√úr√ºn
                    </Typography>
                  </Card>
                </Grid>
              </Grid>
            </CardContent>
          </Card>
        )}

        {/* Executive Product Management */}
        {smartCuttingList && (
          <Card sx={{ mb: 3, elevation: 1 }}>
            <CardContent sx={{ p: 3 }}>
              {/* Section Header */}
              <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mb: 3 }}>
                <Stack direction="row" alignItems="center" spacing={2}>
                  <Avatar sx={{ bgcolor: 'primary.main', width: 40, height: 40 }}>
                    <InventoryIcon />
                  </Avatar>
                  <Box>
                    <Typography variant="h5" sx={{ fontWeight: 700, mb: 0.5 }}>
                      √úr√ºn Portf√∂y√º Y√∂netimi
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      Kesim listesi √ºr√ºnlerini kategorize edin ve y√∂netin
                    </Typography>
                  </Box>
                </Stack>
                <Button
                  variant="contained"
                  size="large"
                  startIcon={<AddIcon />}
                  onClick={() => setShowNewProductDialog(true)}
                  sx={{ 
                    textTransform: 'none',
                    borderRadius: 2,
                    px: 3,
                    py: 1.5,
                    fontWeight: 600
                  }}
                >
                  Yeni √úr√ºn Ekle
                </Button>
              </Stack>
              
              {smartCuttingList.sections?.length === 0 && (
                <Alert severity="info" sx={{ mb: 2 }}>
                  <Typography variant="body2">Hen√ºz bir √ºr√ºn b√∂l√ºm√º eklenmemi≈ü. L√ºtfen yeni bir √ºr√ºn b√∂l√ºm√º ekleyin.</Typography>
                </Alert>
              )}

              <Stack spacing={3}>
                {smartCuttingList.sections?.map((section: SmartProductSection) => (
                    <Card 
                      key={section.id} 
                      variant="outlined" 
                      sx={{ 
                        border: '1px solid #e0e0e0',
                        borderRadius: 2,
                        '&:hover': { 
                          boxShadow: 2,
                          borderColor: 'primary.main'
                        },
                        transition: 'all 0.3s ease'
                      }}
                    >
                      <CardContent sx={{ p: 3 }}>
                        {/* Product Header */}
                        <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mb: 3 }}>
                          <Stack direction="row" alignItems="center" spacing={2}>
                            <Avatar sx={{ bgcolor: 'secondary.main', width: 36, height: 36 }}>
                              <CategoryIcon fontSize="small" />
                            </Avatar>
                            <Box>
                              <Typography variant="h6" sx={{ fontWeight: 700, color: 'primary.main', mb: 0.5 }}>
                                {section.productName}
                              </Typography>
                              <Typography variant="body2" color="text.secondary">
                                √úr√ºn Kategorisi
                              </Typography>
                            </Box>
                          </Stack>
                          <Stack direction="row" spacing={1} alignItems="center">
                            <Chip 
                              label={`${section.items?.length || 0} ƒ∞≈ü Emri`} 
                              size="small" 
                              color="primary"
                              variant="filled"
                              sx={{ fontWeight: 600 }}
                            />
                            <Chip 
                              label={`${section.items?.reduce((total: number, item: SmartWorkOrder) => total + (item.profiles?.length || 0), 0) || 0} Profil`} 
                              size="small" 
                              color="secondary"
                              variant="outlined"
                            />
                          </Stack>
                        </Stack>
                        
                        {section.items?.length === 0 ? (
                          <Alert severity="info" sx={{ mb: 2 }}>
                            Bu √ºr√ºn i√ßin hen√ºz i≈ü emri eklenmemi≈ü.
                          </Alert>
                        ) : (
                          <Stack spacing={2} sx={{ mb: 3 }}>
                            {section.items?.map((item: SmartWorkOrder) => (
                              <Card 
                                key={item.id} 
                                variant="outlined"
                                sx={{ 
                                  border: '1px solid #f0f0f0',
                                  borderRadius: 1.5,
                                  bgcolor: 'grey.50',
                                  '&:hover': { 
                                    bgcolor: 'primary.50',
                                    borderColor: 'primary.light'
                                  },
                                  transition: 'all 0.2s ease'
                                }}
                              >
                                <CardContent sx={{ p: 2.5 }}>
                                  <Stack direction="row" justifyContent="space-between" alignItems="flex-start">
                                    <Box flex={1}>
                                      <Stack direction="row" alignItems="center" spacing={2} sx={{ mb: 2 }}>
                                        <Avatar sx={{ bgcolor: 'info.main', width: 28, height: 28 }}>
                                          <AssignmentIcon sx={{ fontSize: 16 }} />
                                        </Avatar>
                                        <Box>
                                          <Typography variant="subtitle1" sx={{ fontWeight: 700, color: 'primary.main' }}>
                                            ƒ∞≈ü Emri #{item.workOrderId}
                                          </Typography>
                                          <Typography variant="caption" color="text.secondary">
                                            {new Date(item.date).toLocaleDateString('tr-TR')}
                                          </Typography>
                                        </Box>
                                      </Stack>
                                      
                                      <Grid container spacing={1} sx={{ mb: 2 }}>
                                        <Grid item xs={6} sm={3}>
                                          <Typography variant="caption" color="text.secondary">Versiyon</Typography>
                                          <Typography variant="body2" sx={{ fontWeight: 600 }}>{item.version}</Typography>
                                        </Grid>
                                        <Grid item xs={6} sm={3}>
                                          <Typography variant="caption" color="text.secondary">Renk</Typography>
                                          <Typography variant="body2" sx={{ fontWeight: 600 }}>{item.color}</Typography>
                                        </Grid>
                                        <Grid item xs={6} sm={3}>
                                          <Typography variant="caption" color="text.secondary">Adet</Typography>
                                          <Typography variant="body2" sx={{ fontWeight: 600 }}>{item.orderQuantity}</Typography>
                                        </Grid>
                                        <Grid item xs={6} sm={3}>
                                          <Typography variant="caption" color="text.secondary">Ebat</Typography>
                                          <Typography variant="body2" sx={{ fontWeight: 600 }}>{item.size}</Typography>
                                        </Grid>
                                      </Grid>
                                      
                                      {item.profiles.length > 0 && (
                                        <Box>
                                          <Typography variant="caption" color="text.secondary" sx={{ mb: 1, display: 'block' }}>
                                            Profil Detaylarƒ± ({item.profiles.length} adet)
                                          </Typography>
                                          <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
                                            {item.profiles.map((profile: SmartProfileItem, index: number) => (
                                              <Chip
                                                key={profile.id || `${item.id}-profile-${index}`}
                                                label={`${profile.profile || 'N/A'}: ${profile.measurement}mm (${profile.quantity}x)`}
                                                size="small"
                                                variant="outlined"
                                                color="secondary"
                                                sx={{ fontSize: '0.75rem' }}
                                              />
                                            ))}
                                          </Box>
                                        </Box>
                                      )}
                                    </Box>
                                
                                    <Stack spacing={1}>
                                      <Button
                                        size="small"
                                        variant="outlined"
                                        color="primary"
                                        startIcon={<EditIcon />}
                                        onClick={() => handleEditItem(section.id, item)}
                                        sx={{ textTransform: 'none', minWidth: 'auto' }}
                                      >
                                        D√ºzenle
                                      </Button>
                                      <Button
                                        size="small"
                                        variant="outlined"
                                        color="error"
                                        startIcon={<DeleteIcon />}
                                        onClick={() => {
                                          if (window.confirm('Bu i≈ü emrini silmek istediƒüinizden emin misiniz?')) {
                                            deleteItem(section.id, item.id);
                                          }
                                        }}
                                        sx={{ textTransform: 'none', minWidth: 'auto' }}
                                      >
                                        Sil
                                      </Button>
                                    </Stack>
                                  </Stack>
                                </CardContent>
                              </Card>
                            ))}
                          </Stack>
                        )}
                        
                        {/* Executive Action Bar */}
                        <Stack 
                          direction="row" 
                          spacing={2} 
                          sx={{ 
                            pt: 2, 
                            borderTop: '1px solid #f0f0f0',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                          }}
                        >
                          <Button
                            variant="contained"
                            size="medium"
                            startIcon={<AddIcon />}
                            onClick={() => {
                              setCurrentSectionId(section.id);
                              setShowNewItemDialog(true);
                            }}
                            sx={{ 
                              textTransform: 'none',
                              borderRadius: 1.5,
                              px: 3,
                              fontWeight: 600
                            }}
                          >
                            Yeni ƒ∞≈ü Emri Ekle
                          </Button>
                          <Button
                            variant="text"
                            size="small"
                            color="error"
                            startIcon={<DeleteIcon />}
                            onClick={() => {
                              if (window.confirm('Bu √ºr√ºn kategorisini ve t√ºm i≈ü emirlerini silmek istediƒüinizden emin misiniz?')) {
                                deleteSection(section.id);
                              }
                            }}
                            sx={{ textTransform: 'none' }}
                          >
                            Kategoriyi Sil
                          </Button>
                        </Stack>
                      </CardContent>
                    </Card>
                ))}
              </Stack>
            </CardContent>
          </Card>
        )}

        {/* Enhanced New Product Dialog */}
        <Dialog 
          open={showNewProductDialog} 
          onClose={() => {
            setShowNewProductDialog(false);
            setProductNameSuggestions([]);
          }}
          maxWidth="md"
          fullWidth
          PaperProps={{
            sx: {
              borderRadius: 3,
              boxShadow: '0 20px 40px rgba(0,0,0,0.1)',
            }
          }}
        >
          <DialogTitle sx={{ 
            background: gradients.primary, 
            color: 'white', 
            p: 3,
            display: 'flex',
            alignItems: 'center',
            gap: 2
          }}>
            <Avatar sx={{ bgcolor: 'rgba(255,255,255,0.2)' }}>
              <CategoryIcon />
            </Avatar>
            <Box>
              <Typography variant="h5" sx={{ fontWeight: 700, mb: 0.5 }}>
                Yeni √úr√ºn Kategorisi Ekle
              </Typography>
              <Typography variant="body2" sx={{ opacity: 0.9 }}>
                Smart AI destekli √ºr√ºn y√∂netimi
              </Typography>
            </Box>
          </DialogTitle>
          <DialogContent sx={{ p: 3, bgcolor: 'grey.50' }}>
            <Card variant="outlined" sx={{ mb: 3, bgcolor: 'white' }}>
              <CardContent sx={{ p: 3 }}>
                <Stack spacing={3}>
                  <TextField
                    fullWidth
                    size="medium"
                    label="√úr√ºn Adƒ±"
                    placeholder="√ñrnek: 100x50x20, L PROFƒ∞L, KARE BORU"
                    value={productName || ''}
                    onChange={handleProductNameChange}
                    variant="outlined"
                    InputProps={{
                      endAdornment: productNameSuggestions.length > 0 && (
                        <Tooltip title="Ge√ßmi≈ü √úr√ºnlerden AI √ñnerileri Mevcut">
                          <Avatar sx={{ width: 28, height: 28, bgcolor: 'success.main' }}>
                            <AnalyticsIcon sx={{ fontSize: 16 }} />
                          </Avatar>
                        </Tooltip>
                      )
                    }}
                    sx={{ 
                      '& .MuiOutlinedInput-root': {
                        fontSize: '1.1rem',
                        fontWeight: 500
                      }
                    }}
                  />

                  {/* Smart Product Name Suggestions from History */}
                  {productNameSuggestions.length > 0 && (
                    <Box>
                      <Stack direction="row" alignItems="center" spacing={1} sx={{ mb: 2 }}>
                        <Avatar sx={{ width: 24, height: 24, bgcolor: 'info.main' }}>
                          <DashboardIcon sx={{ fontSize: 14 }} />
                        </Avatar>
                        <Typography variant="subtitle2" sx={{ fontWeight: 600, color: 'info.main' }}>
                          Ge√ßmi≈ü Kesim Listelerinden √ñneriler
                        </Typography>
                      </Stack>
                      <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1.5 }}>
                        {productNameSuggestions.map((suggestion, index) => (
                          <Chip
                            key={`product-suggestion-${index}-${suggestion}`}
                            label={suggestion}
                            onClick={() => {
                              setProductName(suggestion);
                              setProductNameSuggestions([]);
                            }}
                            sx={{ 
                              cursor: 'pointer',
                              fontSize: '0.9rem',
                              fontWeight: 500,
                              bgcolor: 'primary.50',
                              color: 'primary.main',
                              border: '1px solid',
                              borderColor: 'primary.200',
                              '&:hover': {
                                bgcolor: 'primary.main',
                                color: 'white',
                                transform: 'translateY(-2px)',
                                boxShadow: 2
                              },
                              transition: 'all 0.2s ease'
                            }}
                            variant="outlined"
                            color="primary"
                          />
                        ))}
                      </Box>
                    </Box>
                  )}

                  {/* AI Suggestions from Profile Hook */}
                  {similarProducts && similarProducts.length > 0 && (
                    <Box>
                      <Stack direction="row" alignItems="center" spacing={1} sx={{ mb: 2 }}>
                        <Avatar sx={{ width: 24, height: 24, bgcolor: 'secondary.main' }}>
                          <AnalyticsIcon sx={{ fontSize: 14 }} />
                        </Avatar>
                        <Typography variant="subtitle2" sx={{ fontWeight: 600, color: 'secondary.main' }}>
                          AI Akƒ±llƒ± √úr√ºn √ñnerileri
                        </Typography>
                      </Stack>
                      <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1.5 }}>
                        {similarProducts && similarProducts.map((product, index) => (
                          <Chip
                            key={product.id || `ai-product-${index}`}
                            label={product.name}
                            onClick={() => {
                              setProductName(product.name);
                            }}
                            sx={{ 
                              cursor: 'pointer',
                              fontSize: '0.9rem',
                              fontWeight: 500,
                              bgcolor: 'secondary.50',
                              color: 'secondary.main',
                              border: '1px solid',
                              borderColor: 'secondary.200',
                              '&:hover': {
                                bgcolor: 'secondary.main',
                                color: 'white',
                                transform: 'translateY(-2px)',
                                boxShadow: 2
                              },
                              transition: 'all 0.2s ease'
                            }}
                            variant="outlined"
                            color="secondary"
                          />
                        ))}
                      </Box>
                    </Box>
                  )}

                  {/* Info Card */}
                  {!productNameSuggestions.length && !(similarProducts && similarProducts.length) && productName.length < 2 && (
                    <Alert severity="info" sx={{ bgcolor: 'info.50', border: '1px solid', borderColor: 'info.200' }}>
                      <Typography variant="body2">
                        <strong>üí° ƒ∞pucu:</strong> √úr√ºn adƒ±nƒ± yazmaya ba≈üladƒ±ƒüƒ±nƒ±zda, ge√ßmi≈ü kesim listelerinizden ve AI'dan akƒ±llƒ± √∂neriler g√∂receksiniz.
                      </Typography>
                    </Alert>
                  )}
                </Stack>
              </CardContent>
            </Card>
          </DialogContent>
          <DialogActions sx={{ 
            p: 3, 
            bgcolor: 'grey.100',
            borderTop: '1px solid #e0e0e0',
            justifyContent: 'space-between'
          }}>
            <Typography variant="body2" color="text.secondary">
              √úr√ºn Adƒ±: <strong>{productName || 'Belirtilmedi'}</strong>
            </Typography>
            <Stack direction="row" spacing={2}>
              <Button 
                variant="outlined"
                onClick={() => {
                  setShowNewProductDialog(false);
                  setProductNameSuggestions([]);
                }}
                sx={{ textTransform: 'none' }}
              >
                ƒ∞ptal
              </Button>
              <Button
                variant="contained"
                onClick={addProductSection}
                disabled={loading || !productName || !productName.trim()}
                startIcon={loading ? <CircularProgress size={20} color="inherit" /> : <AddIcon />}
                sx={{ 
                  textTransform: 'none',
                  fontWeight: 600,
                  px: 3
                }}
              >
                {loading ? 'Ekleniyor...' : '√úr√ºn Kategorisi Ekle'}
              </Button>
            </Stack>
          </DialogActions>
        </Dialog>

        {/* Enhanced New Item Dialog */}
        <Dialog 
          open={showNewItemDialog} 
          onClose={() => setShowNewItemDialog(false)}
          maxWidth="lg"
          fullWidth
          PaperProps={{
            sx: {
              borderRadius: 3,
              boxShadow: '0 20px 40px rgba(0,0,0,0.1)',
              minHeight: '80vh'
            }
          }}
        >
          <DialogTitle sx={{ 
            background: gradients.primary, 
            color: 'white', 
            p: 3,
            display: 'flex',
            alignItems: 'center',
            gap: 2
          }}>
            <Avatar sx={{ bgcolor: 'rgba(255,255,255,0.2)', width: 48, height: 48 }}>
              <AssignmentIcon />
            </Avatar>
            <Box>
              <Typography variant="h5" sx={{ fontWeight: 700, mb: 0.5 }}>
                Yeni ƒ∞≈ü Emri Olu≈üturma Merkezi
              </Typography>
              <Typography variant="body2" sx={{ opacity: 0.9 }}>
                AI Destekli Akƒ±llƒ± ƒ∞≈ü Emri Y√∂netim Sistemi
              </Typography>
            </Box>
          </DialogTitle>
          <DialogContent sx={{ p: 3, bgcolor: 'grey.50' }}>
            
            {/* Smart Suggestion Status Card */}
            <Card variant="outlined" sx={{ mb: 3, bgcolor: 'white' }}>
              <CardContent sx={{ p: 2 }}>
                <Stack direction="row" spacing={2} alignItems="center">
                  <Avatar sx={{ bgcolor: 'info.main', width: 36, height: 36 }}>
                    <PsychologyIcon />
                  </Avatar>
                  <Box flex={1}>
                    <Typography variant="subtitle1" sx={{ fontWeight: 600, mb: 0.5 }}>
                      Akƒ±llƒ± √ñneri Sistemi Durumu
                    </Typography>
                    <Stack direction="row" spacing={2} alignItems="center">
                      <Chip 
                        label={`${availableSizes.length} Ebat √ñnerisi`} 
                        size="small" 
                        color="primary" 
                        variant="outlined"
                        icon={<StraightenIcon />}
                      />
                      <Chip 
                        label={`${enterpriseProfileSuggestions.length} Profil √ñnerisi`} 
                        size="small" 
                        color="secondary" 
                        variant="outlined"
                        icon={<ArchitectureIcon />}
                      />
                      <Chip 
                        label={completeProfileSet ? "Tam Set Hazƒ±r" : "Veri Analiz Ediliyor"} 
                        size="small" 
                        color={completeProfileSet ? "success" : "warning"}
                        variant="filled"
                        icon={<AutoAwesomeIcon />}
                      />
                    </Stack>
                  </Box>
                </Stack>
              </CardContent>
            </Card>

            {/* Main Form Card */}
            <Card variant="outlined" sx={{ mb: 3, bgcolor: 'white' }}>
              <CardContent sx={{ p: 3 }}>
                <Typography variant="h6" sx={{ mb: 3, display: 'flex', alignItems: 'center', gap: 1 }}>
                  <BadgeIcon color="primary" />
                  Temel ƒ∞≈ü Emri Bilgileri
                </Typography>
                
                <Grid container spacing={3}>
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="ƒ∞≈ü Emri Numarasƒ±"
                      placeholder="√ñrnek: WO-123456"
                      value={newItemForm.workOrderId}
                      onChange={(e) => handleFormChange('workOrderId', e.target.value)}
                      variant="outlined"
                      InputProps={{
                        startAdornment: (
                          <Avatar sx={{ width: 24, height: 24, bgcolor: 'primary.main', mr: 1 }}>
                            <NumbersIcon sx={{ fontSize: 14 }} />
                          </Avatar>
                        )
                      }}
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          '&:hover fieldset': { borderColor: 'primary.main' },
                          '&.Mui-focused fieldset': { borderWidth: 2 }
                        }
                      }}
                    />
                  </Grid>
                  
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="√úretim Tarihi"
                      type="date"
                      value={newItemForm.date}
                      onChange={(e) => handleFormChange('date', e.target.value)}
                      variant="outlined"
                      InputLabelProps={{ shrink: true }}
                      InputProps={{
                        startAdornment: (
                          <Avatar sx={{ width: 24, height: 24, bgcolor: 'info.main', mr: 1 }}>
                            <DateRangeIcon sx={{ fontSize: 14 }} />
                          </Avatar>
                        )
                      }}
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          '&:hover fieldset': { borderColor: 'info.main' },
                          '&.Mui-focused fieldset': { borderWidth: 2 }
                        }
                      }}
                    />
                  </Grid>
                  
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="Versiyon Kodu"
                      placeholder="√ñrnek: A1, B2, C3"
                      value={newItemForm.version}
                      onChange={(e) => handleFormChange('version', e.target.value)}
                      variant="outlined"
                      InputProps={{
                        startAdornment: (
                          <Avatar sx={{ width: 24, height: 24, bgcolor: 'secondary.main', mr: 1 }}>
                            <BadgeIcon sx={{ fontSize: 14 }} />
                          </Avatar>
                        )
                      }}
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          '&:hover fieldset': { borderColor: 'secondary.main' },
                          '&.Mui-focused fieldset': { borderWidth: 2 }
                        }
                      }}
                    />
                  </Grid>
                  
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="Renk Spesifikasyonu"
                      placeholder="√ñrnek: KIRMIZI RAL 3020"
                      value={newItemForm.color}
                      onChange={(e) => handleFormChange('color', e.target.value)}
                      variant="outlined"
                      InputProps={{
                        startAdornment: (
                          <Avatar sx={{ width: 24, height: 24, bgcolor: 'warning.main', mr: 1 }}>
                            <PaletteIcon sx={{ fontSize: 14 }} />
                          </Avatar>
                        ),
                        endAdornment: newItemForm.color.length > 1 && (
                          <Tooltip title="Renk √ñnerileri Mevcut">
                            <Avatar sx={{ width: 20, height: 20, bgcolor: 'success.main' }}>
                              <LightbulbIcon sx={{ fontSize: 12 }} />
                            </Avatar>
                          </Tooltip>
                        )
                      }}
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          '&:hover fieldset': { borderColor: 'warning.main' },
                          '&.Mui-focused fieldset': { borderWidth: 2 }
                        }
                      }}
                    />
                  </Grid>
                  
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="Sipari≈ü Adedi"
                      type="number"
                      value={newItemForm.orderQuantity}
                      onChange={(e) => handleFormChange('orderQuantity', e.target.value)}
                      variant="outlined"
                      inputProps={{ min: 1 }}
                      InputProps={{
                        startAdornment: (
                          <Avatar sx={{ width: 24, height: 24, bgcolor: 'success.main', mr: 1 }}>
                            <NumbersIcon sx={{ fontSize: 14 }} />
                          </Avatar>
                        ),
                        endAdornment: <Typography variant="caption" color="text.secondary">adet</Typography>
                      }}
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          '&:hover fieldset': { borderColor: 'success.main' },
                          '&.Mui-focused fieldset': { borderWidth: 2 }
                        }
                      }}
                    />
                  </Grid>
                  
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="√úr√ºn Ebatƒ±"
                      placeholder="√ñrnek: 100x50x20mm"
                      value={newItemForm.size}
                      onChange={(e) => handleFormChange('size', e.target.value)}
                      variant="outlined"
                      InputProps={{
                        startAdornment: (
                          <Avatar sx={{ width: 24, height: 24, bgcolor: 'primary.main', mr: 1 }}>
                            <StraightenIcon sx={{ fontSize: 14 }} />
                          </Avatar>
                        ),
                        endAdornment: (
                          <Stack direction="row" spacing={0.5} alignItems="center">
                            {newItemForm.size.length > 1 && (
                              <Tooltip title="Akƒ±llƒ± Ebat √ñnerileri">
                                <Avatar sx={{ width: 20, height: 20, bgcolor: 'info.main' }}>
                                  <LightbulbIcon sx={{ fontSize: 12 }} />
                                </Avatar>
                              </Tooltip>
                            )}
                            <Typography variant="caption" color="text.secondary">mm</Typography>
                          </Stack>
                        )
                      }}
                      helperText={
                        newItemForm.size.length > 1 ? 
                          enterpriseProfileSuggestions.length > 0 ? 
                            `üß† ${enterpriseProfileSuggestions.length} geli≈ümi≈ü √∂neri bulundu` : 
                            "üîç Akƒ±llƒ± √∂neriler analiz ediliyor..." 
                          : "√úr√ºn ebatƒ±nƒ± girin (√∂rn: 100x50x20)"
                      }
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          '&:hover fieldset': { borderColor: 'primary.main' },
                          '&.Mui-focused fieldset': { borderWidth: 2 }
                        }
                      }}
                    />
                  </Grid>
                  
                  <Grid item xs={12}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="√ñzel Notlar ve Talimatlar"
                      placeholder="√úretim i√ßin √∂zel talimatlar, kalite gereksinimleri, m√º≈üteri notlarƒ±..."
                      value={newItemForm.note}
                      onChange={(e) => handleFormChange('note', e.target.value)}
                      variant="outlined"
                      multiline
                      rows={3}
                      InputProps={{
                        startAdornment: (
                          <Avatar sx={{ width: 24, height: 24, bgcolor: 'grey.600', mr: 1, alignSelf: 'flex-start', mt: 1 }}>
                            <NotesIcon sx={{ fontSize: 14 }} />
                          </Avatar>
                        )
                      }}
                      sx={{
                        '& .MuiOutlinedInput-root': {
                          '&:hover fieldset': { borderColor: 'grey.600' },
                          '&.Mui-focused fieldset': { borderWidth: 2 }
                        }
                      }}
                    />
                  </Grid>
                </Grid>
              </CardContent>
            </Card>

            {/* Available Sizes Card */}
            {availableSizes.length > 0 && (
              <Card variant="outlined" sx={{ mb: 3, bgcolor: 'white' }}>
                <CardContent sx={{ p: 3 }}>
                  <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mb: 2 }}>
                    <Typography variant="h6" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                      <StraightenIcon color="primary" />
                      Bu √úr√ºn ƒ∞√ßin Mevcut Ebatlar
                    </Typography>
                    <Chip 
                      label={`${availableSizes.length} Ebat`} 
                      size="small" 
                      color="primary" 
                      variant="filled"
                    />
                  </Stack>
                  <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1.5 }}>
                    {availableSizes.map((sizeData, index) => (
                      <Chip
                        key={`available-size-${index}-${sizeData.size}`}
                        label={`${sizeData.size} (${sizeData.frequency}x)`}
                        onClick={() => {
                          handleFormChange('size', sizeData.size);
                          // Trigger complete profile set loading with order quantity
                          const currentSection = smartCuttingList?.sections.find((s: SmartProductSection) => s.id === currentSectionId);
                          if (currentSection?.productName) {
                            getCompleteProfileSet(currentSection.productName, sizeData.size, newItemForm.orderQuantity);
                          }
                        }}
                        sx={{ 
                          cursor: 'pointer',
                          fontSize: '0.875rem',
                          fontWeight: 500,
                          bgcolor: 'primary.50',
                          color: 'primary.main',
                          border: '1px solid',
                          borderColor: 'primary.200',
                          '&:hover': {
                            bgcolor: 'primary.main',
                            color: 'white',
                            transform: 'translateY(-2px)',
                            boxShadow: 3
                          },
                          transition: 'all 0.2s ease'
                        }}
                        variant="outlined"
                        color="primary"
                        icon={<StraightenIcon />}
                      />
                    ))}
                  </Box>
                </CardContent>
              </Card>
            )}

            {/* Smart Suggestions Action Card - SADECE EBAT Gƒ∞Rƒ∞LDƒ∞KTEN VE DATA VARSA G√ñSTER */}
            {newItemForm.size.length > 2 && completeProfileSet && completeProfileSet.profiles.length > 0 && (
              <Card variant="outlined" sx={{ mb: 3, bgcolor: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' }}>
                <CardContent sx={{ p: 3 }}>
                  <Stack direction="row" justifyContent="space-between" alignItems="center">
                    <Box>
                      <Typography variant="h6" sx={{ color: 'white', fontWeight: 700, mb: 1, display: 'flex', alignItems: 'center', gap: 1 }}>
                        <AutoAwesomeIcon />
                        Geli≈ümi≈ü √ñneriler Hazƒ±r
                      </Typography>
                      <Typography variant="body2" sx={{ color: 'rgba(255,255,255,0.9)' }}>
                        {`${completeProfileSet.totalItems} profil otomatik forma eklenebilir (Ortalama ${completeProfileSet.averageTotalQuantity} adet)`}
                      </Typography>
                    </Box>
                    <Button
                      variant="contained"
                      size="large"
                      onClick={applyCompleteProfileSet}
                      disabled={!completeProfileSet || !newItemForm.size || completeProfileSet.profiles.length === 0}
                      startIcon={<SmartButtonIcon />}
                      sx={{
                        bgcolor: 'rgba(255,255,255,0.2)',
                        color: 'white',
                        border: '1px solid rgba(255,255,255,0.3)',
                        backdropFilter: 'blur(10px)',
                        fontWeight: 600,
                        px: 3,
                        py: 1.5,
                        '&:hover': {
                          bgcolor: 'rgba(255,255,255,0.3)',
                          transform: 'translateY(-2px)',
                          boxShadow: '0 8px 25px rgba(0,0,0,0.3)'
                        },
                        '&:disabled': {
                          bgcolor: 'rgba(255,255,255,0.1)',
                          color: 'rgba(255,255,255,0.6)'
                        },
                        transition: 'all 0.3s ease'
                      }}
                    >
                      √ñnerileri Uygula
                    </Button>
                  </Stack>
                  
                  {contextualInsights.length > 0 && (
                    <Box sx={{ mt: 2, p: 2, bgcolor: 'rgba(255,255,255,0.1)', borderRadius: 2 }}>
                      <Typography variant="caption" sx={{ color: 'rgba(255,255,255,0.9)', fontStyle: 'italic' }}>
                        üí° {contextualInsights[0]}
                      </Typography>
                    </Box>
                  )}
                </CardContent>
              </Card>
            )}

            {/* No Data Message - Sadece ebat tam girildikten sonra ve veri yoksa g√∂ster */}
            {newItemForm.size.length > 4 && !completeProfileSet && availableSizes.length === 0 && (
              <Card variant="outlined" sx={{ mb: 3, bgcolor: 'white' }}>
                <CardContent sx={{ p: 3, textAlign: 'center' }}>
                  <Avatar sx={{ width: 64, height: 64, bgcolor: 'grey.100', mx: 'auto', mb: 2 }}>
                    <LightbulbIcon sx={{ fontSize: 32, color: 'grey.400' }} />
                  </Avatar>
                  <Typography variant="h6" sx={{ fontWeight: 600, mb: 1, color: 'text.secondary' }}>
                    Yeni Kombinasyon Ke≈üfedildi!
                  </Typography>
                  <Typography variant="body2" color="text.secondary">
                    Bu √ºr√ºn-ebat kombinasyonu i√ßin hen√ºz ge√ßmi≈ü veri yok. ƒ∞lk i≈üiniz olacak ve gelecekteki √∂neriler i√ßin veri olu≈üturacak!
                  </Typography>
                </CardContent>
              </Card>
            )}
            
            {/* Profile Management Card */}
            <Card variant="outlined" sx={{ mb: 3, bgcolor: 'white' }}>
              <CardContent sx={{ p: 3 }}>
                <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mb: 3 }}>
                  <Typography variant="h6" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                    <ArchitectureIcon color="secondary" />
                    Profil Spesifikasyonlarƒ±
                  </Typography>
                  <Stack direction="row" spacing={1} alignItems="center">
                    <Chip 
                      label={`${newItemForm.profiles.length} Profil`} 
                      size="small" 
                      color="secondary" 
                      variant="filled"
                    />
                    <Chip 
                      label={`${totalQuantityCalculation} Toplam Adet`} 
                      size="small" 
                      color="primary" 
                      variant="outlined"
                    />
                  </Stack>
                </Stack>

                <Stack spacing={3}>
                  {newItemForm.profiles.map((profile, index) => (
                    <Card key={profile.id} variant="outlined" sx={{ bgcolor: 'grey.50', border: '1px solid', borderColor: 'grey.200' }}>
                      <CardContent sx={{ p: 2.5 }}>
                        <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mb: 2 }}>
                          <Typography variant="subtitle1" sx={{ fontWeight: 600, color: 'secondary.main', display: 'flex', alignItems: 'center', gap: 1 }}>
                            <Avatar sx={{ width: 24, height: 24, bgcolor: 'secondary.main' }}>
                              <Typography variant="caption" sx={{ color: 'white', fontWeight: 700 }}>
                                {index + 1}
                              </Typography>
                            </Avatar>
                            Profil #{index + 1}
                          </Typography>
                          <IconButton
                            size="small"
                            color="error"
                            onClick={() => removeProfile(profile.id)}
                            disabled={newItemForm.profiles.length === 1}
                            aria-label="Remove profile"
                            sx={{
                              '&:hover': {
                                bgcolor: 'error.50',
                                transform: 'scale(1.1)'
                              },
                              transition: 'all 0.2s ease'
                            }}
                          >
                            <DeleteIcon fontSize="small" />
                          </IconButton>
                        </Stack>
                        
                        <Grid container spacing={2}>
                          <Grid item xs={12} md={4}>
                            <TextField
                              fullWidth
                              size="medium"
                              label="Profil T√ºr√º"
                              placeholder="√ñrnek: L Profil, U Profil"
                              value={profile.profile}
                              onChange={(e) => handleProfileChange(profile.id, 'profile', e.target.value)}
                              variant="outlined"
                              InputProps={{
                                startAdornment: (
                                  <Avatar sx={{ width: 20, height: 20, bgcolor: 'secondary.main', mr: 1 }}>
                                    <ArchitectureIcon sx={{ fontSize: 12 }} />
                                  </Avatar>
                                ),
                                endAdornment: profileSuggestions.length > 0 && (
                                  <Tooltip title="Akƒ±llƒ± Profil √ñnerileri Mevcut">
                                    <Avatar sx={{ width: 18, height: 18, bgcolor: 'success.main' }}>
                                      <LightbulbIcon sx={{ fontSize: 10 }} />
                                    </Avatar>
                                  </Tooltip>
                                )
                              }}
                              sx={{
                                '& .MuiOutlinedInput-root': {
                                  '&:hover fieldset': { borderColor: 'secondary.main' },
                                  '&.Mui-focused fieldset': { borderWidth: 2, borderColor: 'secondary.main' }
                                }
                              }}
                            />
                            
                            {/* Enterprise Profile Suggestions */}
                            {enterpriseProfileSuggestions.length > 0 && (
                              <Box sx={{ mt: 1 }}>
                                <Typography variant="caption" color="primary" sx={{ mb: 0.5, display: 'block', fontWeight: 600 }}>
                                  üß† Geli≈ümi≈ü √ñneriler:
                                </Typography>
                                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                                  {enterpriseProfileSuggestions.slice(0, 4).map((suggestion, idx) => (
                                    <Chip
                                      key={`enterprise-suggestion-${profile.id}-${idx}-${suggestion.profile}`}
                                      label={`${suggestion.profile} (${suggestion.confidence}%)`}
                                      size="small"
                                      variant="filled"
                                      color="primary"
                                      onClick={() => {
                                        handleProfileChange(profile.id, 'profile', suggestion.profile);
                                        handleProfileChange(profile.id, 'measurement', suggestion.measurement);
                                        handleProfileChange(profile.id, 'quantity', suggestion.suggestedQuantity.toString());
                                      }}
                                      sx={{ 
                                        cursor: 'pointer', 
                                        fontSize: '0.7rem',
                                        '&:hover': { transform: 'scale(1.05)', boxShadow: 2 }
                                      }}
                                    />
                                  ))}
                                </Box>
                              </Box>
                            )}

                            {/* Basic Profile Suggestions (Fallback) */}
                            {profileSuggestions.length > 0 && enterpriseProfileSuggestions.length === 0 && profile.profile.length > 1 && (
                              <Box sx={{ mt: 1 }}>
                                <Typography variant="caption" color="text.secondary" sx={{ mb: 0.5, display: 'block' }}>
                                  Temel √ñneriler:
                                </Typography>
                                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                                  {profileSuggestions.slice(0, 3).map((suggestion, idx) => (
                                    <Chip
                                      key={`profile-suggestion-${profile.id}-${idx}-${suggestion}`}
                                      label={suggestion}
                                      size="small"
                                      variant="outlined"
                                      color="secondary"
                                      onClick={() => handleProfileChange(profile.id, 'profile', suggestion)}
                                      sx={{ cursor: 'pointer', fontSize: '0.7rem' }}
                                    />
                                  ))}
                                </Box>
                              </Box>
                            )}
                          </Grid>
                          
                          <Grid item xs={12} md={4}>
                            <TextField
                              fullWidth
                              size="medium"
                              label="√ñl√ß√º Spesifikasyonu"
                              placeholder="√ñrnek: 2000mm, 1500x800"
                              value={profile.measurement}
                              onChange={(e) => handleProfileChange(profile.id, 'measurement', e.target.value)}
                              variant="outlined"
                              InputProps={{
                                startAdornment: (
                                  <Avatar sx={{ width: 20, height: 20, bgcolor: 'info.main', mr: 1 }}>
                                    <StraightenIcon sx={{ fontSize: 12 }} />
                                  </Avatar>
                                ),
                                endAdornment: (
                                  <Stack direction="row" spacing={0.5} alignItems="center">
                                    {measurementSuggestions.length > 0 && profile.profile.length > 2 && (
                                      <Tooltip title="Standart √ñl√ß√º √ñnerileri">
                                        <Avatar sx={{ width: 18, height: 18, bgcolor: 'warning.main' }}>
                                          <LightbulbIcon sx={{ fontSize: 10 }} />
                                        </Avatar>
                                      </Tooltip>
                                    )}
                                    <Typography variant="caption" color="text.secondary">mm</Typography>
                                  </Stack>
                                )
                              }}
                              sx={{
                                '& .MuiOutlinedInput-root': {
                                  '&:hover fieldset': { borderColor: 'info.main' },
                                  '&.Mui-focused fieldset': { borderWidth: 2, borderColor: 'info.main' }
                                }
                              }}
                            />
                            
                            {/* Smart Measurement Suggestions */}
                            {measurementSuggestions.length > 0 && profile.profile.length > 2 && (
                              <Box sx={{ mt: 1 }}>
                                <Typography variant="caption" color="info.main" sx={{ mb: 0.5, display: 'block', fontWeight: 600 }}>
                                  üìè Standart √ñl√ß√ºler:
                                </Typography>
                                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5 }}>
                                  {measurementSuggestions.slice(0, 4).map((suggestion, idx) => (
                                    <Chip
                                      key={`measurement-suggestion-${profile.id}-${idx}-${suggestion}`}
                                      label={`${suggestion}mm`}
                                      size="small"
                                      variant="outlined"
                                      color="info"
                                      onClick={() => handleProfileChange(profile.id, 'measurement', suggestion)}
                                      sx={{ 
                                        cursor: 'pointer', 
                                        fontSize: '0.7rem',
                                        '&:hover': { transform: 'scale(1.05)', boxShadow: 1 }
                                      }}
                                    />
                                  ))}
                                </Box>
                              </Box>
                            )}
                          </Grid>
                          
                          <Grid item xs={12} md={4}>
                            <TextField
                              fullWidth
                              size="medium"
                              label="Gerekli Adet"
                              type="number"
                              value={profile.quantity}
                              onChange={(e) => handleProfileChange(profile.id, 'quantity', e.target.value)}
                              variant="outlined"
                              inputProps={{ min: 1 }}
                              InputProps={{
                                startAdornment: (
                                  <Avatar sx={{ width: 20, height: 20, bgcolor: 'success.main', mr: 1 }}>
                                    <NumbersIcon sx={{ fontSize: 12 }} />
                                  </Avatar>
                                ),
                                endAdornment: <Typography variant="caption" color="text.secondary">adet</Typography>
                              }}
                              sx={{
                                '& .MuiOutlinedInput-root': {
                                  '&:hover fieldset': { borderColor: 'success.main' },
                                  '&.Mui-focused fieldset': { borderWidth: 2, borderColor: 'success.main' }
                                }
                              }}
                            />
                            
                            {/* Quantity Validation */}
                            {parseInt(profile.quantity) > 0 && (
                              <Box sx={{ mt: 0.5 }}>
                                <Typography variant="caption" color="success.main" sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <Avatar sx={{ width: 16, height: 16, bgcolor: 'success.main' }}>
                                    <Typography variant="caption" sx={{ color: 'white', fontSize: '10px' }}>‚úì</Typography>
                                  </Avatar>
                                  Toplam: {parseInt(profile.quantity) || 0} adet
                                </Typography>
                              </Box>
                            )}
                          </Grid>
                        </Grid>
                      </CardContent>
                    </Card>
                  ))}
                </Stack>
                
                {/* Add Profile Button */}
                <Box sx={{ mt: 3, textAlign: 'center' }}>
                  <Button
                    variant="contained"
                    size="large"
                    startIcon={<AddIcon />}
                    onClick={addProfile}
                    sx={{ 
                      borderRadius: 2,
                      px: 4,
                      py: 1.5,
                      fontWeight: 600,
                      textTransform: 'none',
                      background: 'linear-gradient(45deg, #2196F3 30%, #21CBF3 90%)',
                      boxShadow: '0 3px 5px 2px rgba(33, 203, 243, .3)',
                      '&:hover': {
                        background: 'linear-gradient(45deg, #1976D2 30%, #1CB5E0 90%)',
                        transform: 'translateY(-2px)',
                        boxShadow: '0 6px 10px 4px rgba(33, 203, 243, .3)'
                      },
                      transition: 'all 0.3s ease'
                    }}
                  >
                    Yeni Profil Ekle
                  </Button>
                </Box>
              </CardContent>
            </Card>
          </DialogContent>
          
          {/* Enhanced Dialog Actions */}
          <DialogActions sx={{ 
            p: 3, 
            bgcolor: 'grey.100',
            borderTop: '1px solid #e0e0e0',
            justifyContent: 'space-between'
          }}>
            <Stack direction="row" spacing={2} alignItems="center">
              <Typography variant="body2" color="text.secondary">
                Form Durumu:
              </Typography>
              {isFormValid ? (
                <Chip 
                  label="Hazƒ±r" 
                  size="small" 
                  color="success" 
                  icon={<AutoAwesomeIcon />}
                  sx={{ fontWeight: 600 }}
                />
              ) : (
                <Chip 
                  label="Eksik Bilgi" 
                  size="small" 
                  color="warning" 
                  icon={<NotesIcon />}
                  sx={{ fontWeight: 600 }}
                />
              )}
              <Typography variant="body2" color="text.secondary">
                ‚Ä¢
              </Typography>
              <Typography variant="body2" color="text.secondary">
                <strong>{newItemForm.profiles.length}</strong> Profil ‚Ä¢ <strong>{totalQuantityCalculation}</strong> Toplam Adet
              </Typography>
            </Stack>
            
            <Stack direction="row" spacing={2}>
              <Button 
                variant="outlined"
                size="large"
                onClick={() => {
                  setShowNewItemDialog(false);
                  resetNewItemForm();
                }}
                startIcon={<DeleteIcon />}
                sx={{ 
                  textTransform: 'none',
                  px: 3,
                  borderRadius: 2,
                  borderColor: 'grey.300',
                  color: 'text.secondary',
                  '&:hover': {
                    borderColor: 'error.main',
                    color: 'error.main',
                    bgcolor: 'error.50'
                  }
                }}
              >
                ƒ∞ptal Et
              </Button>
              <Button
                variant="contained"
                size="large"
                onClick={addItemToSection}
                disabled={loading || !isFormValid}
                startIcon={loading ? <CircularProgress size={20} color="inherit" /> : <SaveIcon />}
                sx={{ 
                  textTransform: 'none',
                  px: 4,
                  borderRadius: 2,
                  fontWeight: 600,
                  background: isFormValid 
                    ? 'linear-gradient(45deg, #4CAF50 30%, #8BC34A 90%)'
                    : 'grey.300',
                  boxShadow: isFormValid 
                    ? '0 3px 5px 2px rgba(76, 175, 80, .3)'
                    : 'none',
                  '&:hover': isFormValid ? {
                    background: 'linear-gradient(45deg, #388E3C 30%, #689F38 90%)',
                    transform: 'translateY(-2px)',
                    boxShadow: '0 6px 10px 4px rgba(76, 175, 80, .3)'
                  } : {},
                  '&:disabled': {
                    background: 'grey.300',
                    color: 'grey.600'
                  },
                  transition: 'all 0.3s ease'
                }}
              >
                {loading ? 'ƒ∞≈ü Emri Olu≈üturuluyor...' : 'ƒ∞≈ü Emri Olu≈ütur'}
              </Button>
            </Stack>
          </DialogActions>
        </Dialog>

        {/* Executive Edit Item Dialog */}
        <Dialog 
          open={showEditItemDialog} 
          onClose={() => setShowEditItemDialog(false)}
          maxWidth="lg"
          fullWidth
          PaperProps={{
            sx: {
              borderRadius: 3,
              boxShadow: '0 20px 40px rgba(0,0,0,0.1)',
            }
          }}
        >
          <DialogTitle sx={{ 
            background: gradients.primary, 
            color: 'white', 
            p: 3,
            display: 'flex',
            alignItems: 'center',
            gap: 2
          }}>
            <Avatar sx={{ bgcolor: 'rgba(255,255,255,0.2)' }}>
              <EditIcon />
            </Avatar>
            <Box>
              <Typography variant="h5" sx={{ fontWeight: 700, mb: 0.5 }}>
                ƒ∞≈ü Emri D√ºzenleme Merkezi
              </Typography>
              <Typography variant="body2" sx={{ opacity: 0.9 }}>
                Executive Work Order Management System
              </Typography>
            </Box>
          </DialogTitle>
          <DialogContent sx={{ p: 3, bgcolor: 'grey.50' }}>
            {/* Executive Summary Card */}
            <Card variant="outlined" sx={{ mb: 3, bgcolor: 'white' }}>
              <CardContent sx={{ p: 2 }}>
                <Stack direction="row" spacing={3} alignItems="center">
                  <Avatar sx={{ bgcolor: 'info.main', width: 40, height: 40 }}>
                    <AnalyticsIcon />
                  </Avatar>
                  <Box flex={1}>
                    <Typography variant="h6" sx={{ fontWeight: 600, mb: 0.5 }}>
                      ƒ∞≈ü Emri √ñzeti
                    </Typography>
                    <Stack direction="row" spacing={3}>
                      <Typography variant="body2" color="text.secondary">
                        <strong>Profil Sayƒ±sƒ±:</strong> {newItemForm.profiles.length}
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        <strong>Toplam Adet:</strong> {totalQuantityCalculation}
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        <strong>D√ºzenleme Durumu:</strong> <Chip label="Aktif" size="small" color="success" />
                      </Typography>
                    </Stack>
                  </Box>
                </Stack>
              </CardContent>
            </Card>

            {/* Executive Form Layout */}
            <Card variant="outlined" sx={{ mb: 3, bgcolor: 'white' }}>
              <CardContent sx={{ p: 3 }}>
                <Typography variant="h6" sx={{ mb: 2, display: 'flex', alignItems: 'center', gap: 1 }}>
                  <AssignmentIcon color="primary" />
                  Temel Bilgiler
                </Typography>
                <Grid container spacing={3}>
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="ƒ∞≈ü Emri Numarasƒ±"
                      placeholder="√ñrnek: WO-123456"
                      value={newItemForm.workOrderId}
                      onChange={(e) => handleFormChange('workOrderId', e.target.value)}
                      variant="outlined"
                      InputProps={{
                        startAdornment: <Typography variant="body2" color="text.secondary" sx={{ mr: 1 }}>#</Typography>
                      }}
                    />
                  </Grid>
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="√úretim Tarihi"
                      type="date"
                      value={newItemForm.date}
                      onChange={(e) => handleFormChange('date', e.target.value)}
                      variant="outlined"
                      InputLabelProps={{ shrink: true }}
                    />
                  </Grid>
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="Versiyon Kodu"
                      placeholder="√ñrnek: A1, B2, C3"
                      value={newItemForm.version}
                      onChange={(e) => handleFormChange('version', e.target.value)}
                      variant="outlined"
                    />
                  </Grid>
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="Renk Spesifikasyonu"
                      placeholder="√ñrnek: KIRMIZI RAL 3020"
                      value={newItemForm.color}
                      onChange={(e) => handleFormChange('color', e.target.value)}
                      variant="outlined"
                    />
                  </Grid>
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="Sipari≈ü Adedi"
                      type="number"
                      value={newItemForm.orderQuantity}
                      onChange={(e) => handleFormChange('orderQuantity', e.target.value)}
                      variant="outlined"
                      inputProps={{ min: 1 }}
                      InputProps={{
                        endAdornment: <Typography variant="body2" color="text.secondary">adet</Typography>
                      }}
                    />
                  </Grid>
                  <Grid item xs={12} sm={6} md={4}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="√úr√ºn Ebatƒ±"
                      placeholder="√ñrnek: 100x50x20mm"
                      value={newItemForm.size}
                      onChange={(e) => handleFormChange('size', e.target.value)}
                      variant="outlined"
                    />
                  </Grid>
                  <Grid item xs={12}>
                    <TextField
                      fullWidth
                      size="medium"
                      label="√ñzel Notlar ve Talimatlar"
                      placeholder="√úretim i√ßin √∂zel talimatlar, kalite gereksinimleri..."
                      value={newItemForm.note}
                      onChange={(e) => handleFormChange('note', e.target.value)}
                      variant="outlined"
                      multiline
                      rows={3}
                    />
                  </Grid>
                </Grid>
              </CardContent>
            </Card>
            
            {/* Executive Profile Management */}
            <Card variant="outlined" sx={{ bgcolor: 'white' }}>
              <CardContent sx={{ p: 3 }}>
                <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mb: 3 }}>
                  <Stack direction="row" alignItems="center" spacing={2}>
                    <Avatar sx={{ bgcolor: 'secondary.main', width: 36, height: 36 }}>
                      <InventoryIcon fontSize="small" />
                    </Avatar>
                    <Box>
                      <Typography variant="h6" sx={{ fontWeight: 700 }}>
                        Profil Spesifikasyonlarƒ±
                      </Typography>
                      <Typography variant="body2" color="text.secondary">
                        Smart AI destekli profil y√∂netimi
                      </Typography>
                    </Box>
                  </Stack>
                  <Stack direction="row" spacing={2} alignItems="center">
                    <Chip 
                      label={`${newItemForm.profiles.length} Profil`} 
                      size="small" 
                      color="secondary"
                      variant="filled"
                    />
                    <Chip 
                      label={`${totalQuantityCalculation} Toplam Adet`} 
                      size="small" 
                      color="primary"
                      variant="outlined"
                    />
                  </Stack>
                </Stack>

                <Stack spacing={3}>
                  {newItemForm.profiles.map((profile, index) => (
                    <Card key={profile.id} variant="outlined" sx={{ bgcolor: 'grey.50' }}>
                      <CardContent sx={{ p: 2.5 }}>
                        <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mb: 2 }}>
                          <Typography variant="subtitle1" sx={{ fontWeight: 600, color: 'primary.main' }}>
                            Profil #{index + 1}
                          </Typography>
                          <IconButton
                            size="small"
                            color="error"
                            onClick={() => removeProfile(profile.id)}
                            disabled={newItemForm.profiles.length === 1}
                            aria-label="Remove profile"
                          >
                            <DeleteIcon fontSize="small" />
                          </IconButton>
                        </Stack>
                        
                        <Grid container spacing={2}>
                          <Grid item xs={12} md={4}>
                            <TextField
                              fullWidth
                              size="medium"
                              label="Profil T√ºr√º"
                              placeholder="√ñrnek: L Profil, U Profil"
                              value={profile.profile}
                              onChange={(e) => handleProfileChange(profile.id, 'profile', e.target.value)}
                              variant="outlined"
                              InputProps={{
                                endAdornment: profileSuggestions.length > 0 && (
                                  <Tooltip title="AI √ñnerileri Mevcut">
                                    <Avatar sx={{ width: 24, height: 24, bgcolor: 'success.main' }}>
                                      <AnalyticsIcon sx={{ fontSize: 14 }} />
                                    </Avatar>
                                  </Tooltip>
                                )
                              }}
                            />
                            {/* Enterprise Profile Suggestions */}
                            {enterpriseProfileSuggestions.length > 0 && (
                              <Box sx={{ mt: 1 }}>
                                <Typography variant="caption" color="primary" sx={{ mb: 0.5, display: 'block', fontWeight: 600 }}>
                                  üß† Geli≈ümi≈ü √ñneriler:
                                </Typography>
                                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
                                  {enterpriseProfileSuggestions.slice(0, 5).map((suggestion, idx) => (
                                    <Chip
                                      key={`enterprise-suggestion-${profile.id}-${idx}-${suggestion.profile}`}
                                      label={`${suggestion.profile} (${suggestion.confidence}%)`}
                                      size="small"
                                      variant="filled"
                                      color="primary"
                                      onClick={() => {
                                        handleProfileChange(profile.id, 'profile', suggestion.profile);
                                        handleProfileChange(profile.id, 'measurement', suggestion.measurement);
                                        handleProfileChange(profile.id, 'quantity', suggestion.suggestedQuantity.toString());
                                      }}
                                      sx={{ 
                                        cursor: 'pointer', 
                                        fontSize: '0.75rem',
                                        '&:hover': { transform: 'scale(1.05)' }
                                      }}
                                    />
                                  ))}
                                </Box>
                                {contextualInsights.length > 0 && (
                                  <Typography variant="caption" color="text.secondary" sx={{ mt: 0.5, display: 'block', fontStyle: 'italic' }}>
                                    üí° {contextualInsights[0]}
                                  </Typography>
                                )}
                              </Box>
                            )}

                            {/* Smart Profile Suggestions (Fallback) */}
                            {profileSuggestions.length > 0 && enterpriseProfileSuggestions.length === 0 && profile.profile.length > 1 && (
                              <Box sx={{ mt: 1 }}>
                                <Typography variant="caption" color="text.secondary" sx={{ mb: 0.5, display: 'block' }}>
                                  Temel √ñneriler:
                                </Typography>
                                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
                                  {profileSuggestions.slice(0, 3).map((suggestion, idx) => (
                                    <Chip
                                      key={`profile-suggestion-${profile.id}-${idx}-${suggestion}`}
                                      label={suggestion}
                                      size="small"
                                      variant="outlined"
                                      color="primary"
                                      onClick={() => handleProfileChange(profile.id, 'profile', suggestion)}
                                      sx={{ cursor: 'pointer', fontSize: '0.75rem' }}
                                    />
                                  ))}
                                </Box>
                              </Box>
                            )}
                          </Grid>
                          
                          <Grid item xs={12} md={4}>
                            <TextField
                              fullWidth
                              size="medium"
                              label="√ñl√ß√º Spesifikasyonu"
                              placeholder="√ñrnek: 2000mm, 1500x800"
                              value={profile.measurement}
                              onChange={(e) => handleProfileChange(profile.id, 'measurement', e.target.value)}
                              variant="outlined"
                              InputProps={{
                                endAdornment: <Typography variant="caption" color="text.secondary">mm</Typography>
                              }}
                            />
                            {/* Smart Measurement Suggestions */}
                            {measurementSuggestions.length > 0 && profile.profile.length > 2 && (
                              <Box sx={{ mt: 1 }}>
                                <Typography variant="caption" color="text.secondary" sx={{ mb: 0.5, display: 'block' }}>
                                  Standart √ñl√ß√ºler:
                                </Typography>
                                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
                                  {measurementSuggestions.slice(0, 4).map((suggestion, idx) => (
                                    <Chip
                                      key={`measurement-suggestion-${profile.id}-${idx}-${suggestion}`}
                                      label={`${suggestion}mm`}
                                      size="small"
                                      variant="outlined"
                                      color="secondary"
                                      onClick={() => handleProfileChange(profile.id, 'measurement', suggestion)}
                                      sx={{ cursor: 'pointer', fontSize: '0.75rem' }}
                                    />
                                  ))}
                                </Box>
                              </Box>
                            )}
                          </Grid>
                          
                          <Grid item xs={12} md={4}>
                            <TextField
                              fullWidth
                              size="medium"
                              label="Gerekli Adet"
                              type="number"
                              value={profile.quantity}
                              onChange={(e) => handleProfileChange(profile.id, 'quantity', e.target.value)}
                              variant="outlined"
                              inputProps={{ min: 1 }}
                              InputProps={{
                                endAdornment: <Typography variant="caption" color="text.secondary">adet</Typography>
                              }}
                            />
                            {/* Quantity Validation */}
                            {parseInt(profile.quantity) > 0 && (
                              <Box sx={{ mt: 0.5 }}>
                                <Typography variant="caption" color="success.main">
                                  ‚úì Toplam: {parseInt(profile.quantity) || 0} adet
                                </Typography>
                              </Box>
                            )}
                          </Grid>
                        </Grid>
                      </CardContent>
                    </Card>
                  ))}
                </Stack>
                
                {/* Executive Add Profile Button */}
                <Box sx={{ mt: 3, textAlign: 'center' }}>
                  <Button
                    variant="contained"
                    size="large"
                    startIcon={<AddIcon />}
                    onClick={addProfile}
                    sx={{ 
                      borderRadius: 2,
                      px: 4,
                      py: 1.5,
                      fontWeight: 600,
                      textTransform: 'none'
                    }}
                  >
                    Yeni Profil Ekle
                  </Button>
                </Box>
              </CardContent>
            </Card>
          </DialogContent>
          
          {/* Executive Dialog Actions */}
          <DialogActions sx={{ 
            p: 3, 
            bgcolor: 'grey.100',
            borderTop: '1px solid #e0e0e0',
            justifyContent: 'space-between'
          }}>
            <Stack direction="row" spacing={2} alignItems="center">
              <Typography variant="body2" color="text.secondary">
                Form Durumu:
              </Typography>
              {isFormValid ? (
                <Chip label="Ge√ßerli" size="small" color="success" />
              ) : (
                <Chip label="Eksik Bilgi" size="small" color="warning" />
              )}
            </Stack>
            
            <Stack direction="row" spacing={2}>
              <Button 
                variant="outlined"
                size="large"
                onClick={() => {
                  setShowEditItemDialog(false);
                  setEditingItem(null);
                  resetNewItemForm();
                }}
                sx={{ 
                  textTransform: 'none',
                  px: 3,
                  borderRadius: 2
                }}
              >
                ƒ∞ptal Et
              </Button>
              <Button
                variant="contained"
                size="large"
                onClick={updateItemInSection}
                disabled={loading || !isFormValid}
                startIcon={loading ? <CircularProgress size={20} color="inherit" /> : <SaveIcon />}
                sx={{ 
                  textTransform: 'none',
                  px: 4,
                  borderRadius: 2,
                  fontWeight: 600
                }}
              >
                {loading ? 'G√ºncelleniyor...' : 'Deƒüi≈üiklikleri Kaydet'}
              </Button>
            </Stack>
          </DialogActions>
        </Dialog>
    </ErrorBoundary>
  );
};